<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leopard Low Down — Gallery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{colors:{brand:'#C1121F'}}}};</script>
  <style>
    :root { --brand:#C1121F }
    .smallcaps { font-variant: all-small-caps; letter-spacing:.06em; }
    .line-clamp-3 { display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
    .card-shadow { box-shadow: 0 1px 2px rgba(0,0,0,.05); }
    .card-shadow-hover:hover { box-shadow:0 4px 18px -2px rgba(0,0,0,.18), 0 2px 6px -1px rgba(0,0,0,.1); }
    .gradient-fade { background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,.0)); }
    .results-badge { background:linear-gradient(90deg,var(--brand),#e23a45); }
  .focus-input:focus { outline:2px solid var(--brand); outline-offset:2px; }
  .tag-pill { display:inline-block; border:1px solid var(--brand); color:var(--brand); font-variant:all-small-caps; letter-spacing:.06em; font-size:10px; padding:2px 6px; line-height:1; border-radius:2px; background:rgba(193,18,31,0.06); }
  .tag-pill.alt { background:transparent; }
    @media (min-width:1536px){ .xl\:grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr));} }
  </style>
</head>
<body class="bg-white text-neutral-900">
  <header class="border-b border-neutral-200 bg-neutral-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div>
        <p class="smallcaps text-[11px] text-neutral-500 tracking-[0.15em]">Browse</p>
        <h1 class="font-serif text-3xl md:text-4xl font-extrabold tracking-tight mt-1">All Articles</h1>
      </div>
      <a href="Index.html" class="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-600 hover:text-[var(--brand)]">Home</a>
    </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <section class="border border-neutral-200 rounded-sm bg-white sticky top-0 z-20 shadow-sm">
      <form id="filters" class="flex flex-col gap-3 p-4 md:flex-row md:items-end md:gap-4">
        <div class="flex-1 flex flex-col gap-1 text-xs font-medium">
          <label for="qAll" class="flex items-center justify-between">
            <span>Search</span>
            <span class="text-[10px] font-normal text-neutral-400">Title • Category • Author</span>
          </label>
          <div class="relative">
            <input type="text" id="qAll" class="focus-input w-full border border-neutral-300 rounded-sm px-3 py-2 text-sm pr-8" placeholder="Search articles..." />
            <span class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-neutral-400">⌕</span>
          </div>
        </div>
        <div class="flex flex-col gap-1 text-xs font-medium w-full md:w-48">
          <label for="sort">Sort</label>
          <select id="sort" class="focus-input border border-neutral-300 rounded-sm px-2 py-2 text-sm bg-white">
            <option value="latest">Latest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>
        <div class="flex gap-2 pt-1">
          <button type="reset" class="px-3 py-2 text-xs border border-neutral-300 rounded-sm hover:bg-neutral-100">Reset</button>
        </div>
      </form>
      <div class="flex items-center justify-between px-4 pb-3 -mt-1 text-[11px] text-neutral-600">
        <div id="results-meta" aria-live="polite"></div>
        <div class="hidden md:flex gap-2" id="active-flags"></div>
      </div>
    </section>
    <section>
      <div id="results" class="grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5"></div>
    </section>
  </main>

  <template id="article-card-tpl">
    <article class="group border border-neutral-200 rounded-sm overflow-hidden bg-white flex flex-col card-shadow card-shadow-hover transition-all">
      <a class="block relative aspect-[4/3] bg-neutral-100 overflow-hidden">
        <img class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-[1.06]" loading="lazy" />
        <div class="absolute inset-x-0 bottom-0 h-14 gradient-fade pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity"></div>
      </a>
      <div class="border-t border-neutral-200 p-3 flex flex-col gap-1 flex-1">
  <div class="flex flex-wrap gap-1 text-[10px] uppercase tracking-widest" data-category></div>
        <h2 class="font-serif font-semibold text-sm leading-snug">
          <a class="hover:text-[var(--brand)]" data-link></a>
        </h2>
        <p class="text-[11px] text-neutral-500" data-meta></p>
      </div>
    </article>
  </template>

  <script>
    (function(){
      // Cache-buster for fetches to avoid stale JSON
      const ts = Date.now();
  const qAllEl = document.getElementById('qAll');
      const sortEl = document.getElementById('sort');
      const resultsEl = document.getElementById('results');
  const metaEl = document.getElementById('results-meta');
  const flagsEl = document.getElementById('active-flags');
  const tpl = document.getElementById('article-card-tpl');
  // Initialize search from URL (?q=... or ?category=...)
  const params = new URLSearchParams(location.search);
  const initialQ = params.get('q') || params.get('category') || '';
  if (initialQ) { qAllEl.value = initialQ; }

      let articles = [];

      function fetchAll(){
        return fetch(`ArticleCatalog.json?ts=${ts}`)
          .then(r=>r.json())
          .then(cat => Array.isArray(cat.articles) ? cat.articles : [])
          .then(list => Promise.all(list.map(a =>
              fetch(`articles/${encodeURIComponent(a.id)}.json?ts=${ts}`)
                .then(r=> r.ok ? r.json().catch(()=>null) : null)
                .catch(()=>null)
                .then(body => body ? ({...a, ...body}) : null)
            ))
          )
          .then(list => { articles = list.filter(Boolean); render(); });
      }

      function normalize(s){ return (s||'').trim().toLowerCase(); }

      function applyFilters(){
        const query = normalize(qAllEl.value);
        let filtered = articles.slice();
        let activeBadges = [];
        if(query){
          const parts = query.split(/\s+/).filter(Boolean);
          filtered = filtered.filter(a => {
            const hay = [a.title, a.category, (a.tags||[]).join(' '), a.author, a.byline].join(' ').toLowerCase();
            return parts.every(p => hay.includes(p));
          });
          activeBadges = parts.map(p=>`<span class=\"px-2 py-0.5 rounded-full bg-neutral-100 border border-neutral-300 text-[10px]\">${p}</span>`);
        }
        const sort = sortEl.value;
        filtered.sort((a,b)=>{
          switch(sort){
            case 'oldest': return new Date(a.time_posted)-new Date(b.time_posted);
            case 'latest':
            default: return new Date(b.time_posted)-new Date(a.time_posted);
          }
        });
        if(flagsEl) flagsEl.innerHTML = activeBadges.join('');
        return filtered;
      }

      function render(){
        const list = applyFilters();
  const total = articles.length;
  const sortMode = sortEl.value;
  const labels = {latest:'Latest', oldest:'Oldest'};
  metaEl.textContent = `${list.length} of ${total} article${total===1?'':'s'} • ${labels[sortMode]}`;
        resultsEl.innerHTML = '';
        list.forEach(a => {
          const node = tpl.content.firstElementChild.cloneNode(true);
          const link = node.querySelector('a');
          link.href = `LLD-Article-Page.html?id=${encodeURIComponent(a.id)}`;
          const img = node.querySelector('img');
          img.src = a.imageUrl || `https://picsum.photos/seed/${encodeURIComponent(a.id)}-gallery/600/400`;
          img.alt = a.imageAlt || a.title || '';
          node.querySelector('[data-link]').textContent = a.title;
          const catWrap = node.querySelector('[data-category]');
          const cat = a.category || '';
          catWrap.innerHTML = cat ? `<span class=\"tag-pill\">${cat}</span>` : '';
          const posted = a.time_posted ? new Date(a.time_posted) : null;
          const metaBits = [];
          if (posted) metaBits.push(posted.toLocaleDateString('en-US',{month:'short', day:'numeric', year:'numeric'}));
          const auth = a.author || a.byline; if(auth) metaBits.push(auth);
          metaEl.dataset.total = articles.length;
          node.querySelector('[data-meta]').textContent = metaBits.join(' • ');
          resultsEl.appendChild(node);
        });
      }

      // Keep URL in sync with search/sort
      function syncUrl(){
        const url = new URL(location.href);
        const q = qAllEl.value.trim();
        if(q){ url.searchParams.set('q', q); } else { url.searchParams.delete('q'); }
        url.searchParams.set('sort', sortEl.value);
        history.replaceState(null, '', url.toString());
      }
      ['input','change'].forEach(ev => {
        qAllEl.addEventListener(ev, render);
        sortEl.addEventListener(ev, render);
        qAllEl.addEventListener(ev, syncUrl);
        sortEl.addEventListener(ev, syncUrl);
      });
      document.getElementById('filters').addEventListener('reset', ()=>{
        setTimeout(()=>{ syncUrl(); render(); },0);
      });

      fetchAll();
      // Apply initial filter render if q present
      if (initialQ) { render(); }
    })();
  </script>
</body>
</html>
