<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Create New Article (Editorial Port)</title>
  <style>
    /* =====================
       DESIGN TOKENS
       ===================== */
    :root{
      --bg-page: #f8f9fa;       /* Light gray background */
      --bg-panel: #ffffff;      /* White panel background */
      --color-text: #212529;    /* Dark gray for text */
      --color-muted: #6c757d;   /* Muted gray for secondary text */
      --color-border: #dee2e6;  /* Light gray for borders */
      --color-accent: #007bff;  /* Blue accent color */
      --color-accent-soft: #e7f3ff; /* Soft blue for accents */
      --bg-rail: #343a40;       /* Dark background for the rail */
      --radius: 8px;           /* Standard border radius */
      --shadow: 0 4px 12px rgba(0,0,0,.08);
    }

    /* =====================
       BASE / TYPOGRAPHY
       ===================== */
    html, body { height: 100%; margin: 0; }
    body {
      background: var(--bg-page);
      color: var(--color-text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
    }
    .serif{ font-family: Georgia, 'Times New Roman', Times, serif; }
    .smallcaps{ font-variant-caps: all-small-caps; letter-spacing: .05em; color: var(--color-muted); }

    /* =====================
       LAYOUT
       ===================== */
    .app { display: grid; grid-template-columns: 220px 1fr; min-height: 100vh; }
    .rail { background: var(--bg-rail); color: #fff; padding: 24px; }
    .rail h1 { margin: 0; font-size: 28px; letter-spacing: .08em; }
    .main { padding: 32px; }
    .rule { height: 1px; background: var(--color-border); margin: 24px 0; }
    .page-title { font-size: 32px; font-weight: 500; margin: 0 0 24px; }
    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 32px;
      box-shadow: var(--shadow);
    }

    /* =====================
       FORM ELEMENTS
       ===================== */
    .field { margin-bottom: 24px; }
    .label { display: block; margin-bottom: 8px; font-weight: 600; }

    .input, .select, textarea {
      width: 100%;
      background: #f8f9fa;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 12px 16px;
      font-size: 16px;
      color: var(--color-text);
      transition: border-color .2s, box-shadow .2s;
      box-sizing: border-box;
    }
    .input:focus, .select:focus, textarea:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px var(--color-accent-soft);
    }
    #headline { font-size: 24px; font-weight: 500; }

    /* =====================
       META BAR - FIXED STYLES
       ===================== */
    .meta-grid {
      display: grid;
      grid-template-columns: 1fr 120px 2fr 1.5fr;
      gap: 24px;
      align-items: start; /* Changed from end to start to align top of fields */
      margin-bottom: 24px;
    }

    .meta-grid .field {
      margin-bottom: 0;
    }

    .meta-grid .label {
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
    }

    .meta-grid .input,
    .meta-grid .select {
      min-height: 48px;
      font-size: 16px;
    }

    /* Position field specific styling */
    #positiontag {
      text-align: center;
      font-weight: 600;
      font-size: 18px;
    }

    .muted { color: var(--color-muted); }

    /* TAG CHIPS - Dynamic height, vertical overflow */
    .chips { 
      display: flex; 
      gap: 6px; 
      flex-wrap: wrap; 
      overflow-y: auto; 
      padding: 4px 0;
      min-height: 28px;
      align-items: flex-start;
      align-content: flex-start;
      margin-top: 8px; /* Margin to separate from input field */
    }

    .chip {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 8px; border-radius: 12px;
      background: #f1f3f5; border: 1px solid #e9ecef;
      font-size: 12px; cursor: pointer; user-select: none;
      transition: background .2s;
      white-space: nowrap;
      flex-shrink: 0;
      height: 24px;
    }
    .chip[data-active="true"] { background: var(--color-accent-soft); border-color: var(--color-accent); }
    .chip button {
      appearance: none; border: none; background: transparent; cursor: pointer; color: var(--color-muted);
      font-size: 14px; line-height: 1; padding: 0; margin: 0;
      margin-left: 2px;
    }
    .chip-input { 
      display: flex; 
      gap: 8px; 
      align-items: center; 
    }
    .chip-input input { 
      flex-grow: 1; 
      font-size: 14px;
      padding: 8px 12px;
      height: 36px;
    }
    .chip-input .add {
      padding: 8px 12px; 
      border: 1px solid var(--color-border); 
      border-radius: var(--radius);
      background: #fff; 
      cursor: pointer; 
      font-weight: 600;
      transition: background .2s, border-color .2s;
      font-size: 14px;
      height: 36px;
      display: flex;
      align-items: center;
    }
    .chip-input .add:hover { background: #e9ecef; border-color: #adb5bd; }
    .chip-input .add[disabled] { opacity: .5; cursor: not-allowed; }

    /* FILE INPUT - Updated for meta grid */
    .file {
      display: flex; 
      align-items: center;
      gap: 8px; 
      background: #f8f9fa; 
      border: 1px solid var(--color-border);
      border-radius: var(--radius); 
      padding: 6px 10px; /* Shorter padding */
      height: 36px; /* Reduced height */
    }
    .file input { display: none; }
    .file .btn {
      padding: 6px 12px; /* Shorter padding */
      border: 1px solid var(--color-border); 
      border-radius: var(--radius);
      background: #fff; 
      cursor: pointer; 
      font-weight: 500;
      transition: background .2s;
      font-size: 14px;
      white-space: nowrap;
    }
    .file .btn:hover { background: #e9ecef; }
    .file .meta { 
      font-size: 12px; 
      color: var(--color-muted); 
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* TABS + TOOLBAR */
    .tabs { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .tab {
      padding: 10px 18px; border-radius: 20px; border: 1px solid var(--color-border); background: #fff;
      font-size: 14px; font-weight: 500; cursor: pointer; transition: all .2s;
    }
    .tab:hover { border-color: var(--color-accent); }
    .tab[aria-selected="true"] { background: var(--color-accent); color: #fff; border-color: var(--color-accent); }
    .tab[contenteditable="true"] {
      outline: 2px dashed var(--color-accent);
      cursor: text;
      background: #fff; color: var(--color-text);
      min-width: 64px;
    }
    .btn { padding: 10px 18px; border-radius: 20px; border: 1px solid var(--color-text); background: #fff; font-size: 14px; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .btn:focus { outline: 3px solid rgba(0,123,255,0.12); outline-offset: 2px; }
    .toolbar { display: flex; gap: 8px; margin-left: auto; }
  .toolbar select.tselect { align-self: center; }

    /* Compact toolbar selects */
    .tselect {
      background: #fff;
      border: 1px solid var(--color-border);
      border-radius: 16px;
      height: 32px;
      padding: 0 12px;
      font-size: 12px;
      color: var(--color-text);
      cursor: pointer;
    }
    .tselect:focus { outline: none; box-shadow: 0 0 0 3px var(--color-accent-soft); border-color: var(--color-accent); }

    /* Toolbar-themed selects to match pill look */
    .toolbar .tselect {
      background: #495057;
      color: #fff;
      border: none;
      height: 32px;
      border-radius: 16px;
      padding: 0 12px;
    }
    .toolbar .tselect:hover { background: #343a40; }
    .toolbar .tselect:focus { box-shadow: 0 0 0 3px rgba(0,123,255,0.18); }

    /* Drafts widget (rail) */
    .drafts-widget { 
      margin-top: 12px; 
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 8px;
      padding: 10px;
    }
    .drafts-widget .drafts-icon { 
      width: 36px; height: 36px; border-radius: 50%; 
      border: 1px solid rgba(255,255,255,0.3); background: transparent; color: #fff; cursor: pointer; 
      display: inline-flex; align-items: center; justify-content: center; font-size: 16px; 
    }
    .drafts-widget .tselect { width: 100%; margin-top: 8px; }
    .drafts-list { margin-top: 8px; max-height: 200px; overflow: auto; }
    .draft-item { 
      padding: 6px 8px; border-radius: 6px; background: rgba(255,255,255,0.04); 
      border: 1px solid rgba(255,255,255,0.12); color: #fff; font-size: 12px; margin-bottom: 6px; 
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .draft-item .info { min-width: 0; }
    .draft-item .info .title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .draft-item .meta { color: #ced4da; font-size: 11px; }
    .draft-item .del { 
      border: 1px solid rgba(255,255,255,0.35); background: transparent; color: #fff; border-radius: 12px;
      width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .draft-item .del:hover { background: rgba(255,255,255,0.12); }

    .tselect.small { height: 28px; border-radius: 14px; padding: 0 10px; font-size: 12px; }
  .rail .btn.small { height: 28px; padding: 0 10px; font-size: 12px; color: #fff; background: transparent; border-color: rgba(255,255,255,0.35); }
  .rail .btn.small:hover { background: rgba(255,255,255,0.08); }

    /* Modal for Publish */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-backdrop[aria-hidden="false"] { display: flex; }
    .modal { background: #fff; color: var(--color-text); border-radius: 12px; box-shadow: var(--shadow); width: 420px; max-width: 90vw; }
    .modal header { padding: 16px 20px; border-bottom: 1px solid var(--color-border); font-weight: 700; }
    .modal .content { padding: 16px 20px; }
    .modal .actions { padding: 16px 20px; display: flex; gap: 12px; justify-content: flex-end; }
    .modal .actions .btn { border-color: var(--color-border); }

  /* (Removed GitHub modal-specific styles) */

    /* PILL (toolbar) button states */
    .pill {
      background: #495057; color: #fff; border: none; border-radius: 20px;
      padding: 8px 14px; font-size: 12px; cursor: pointer;
      transition: background .12s, transform .06s, box-shadow .12s;
      user-select: none;
    }
    .pill:hover { background: #343a40; }
    .pill:active { transform: translateY(1px); }
  .pill-icon { display: inline-flex; align-items: center; justify-content: center; padding: 6px 10px; }
  .toolbar .group { display: inline-flex; gap: 6px; background: #495057; border-radius: 18px; padding: 2px; }
  .toolbar .group .pill { background: transparent; border: none; }
  .toolbar .group .pill[aria-pressed="true"] { background: var(--color-accent); color: #fff; }
  /* Use standard toolbar select styling for dropdowns inside groups */
    /* pressed / active visual state */
    .pill[aria-pressed="true"] {
      background: var(--color-accent);
      color: #fff;
      box-shadow: 0 6px 18px rgba(0,123,255,0.12);
      transform: translateY(0);
      border: 1px solid rgba(0,0,0,.06);
    }

    /* Image pill with distinct color (teal) */
    .pill-image {
      background: #0ca678; /* teal */
      color: #fff;
    }
    .pill-image:hover { background: #099268; }
    .pill-image:active { transform: translateY(1px); }

    #deletePageBtn {
      background: transparent; color: #dc3545; border: 1px solid #f5c6cb;
      padding: 8px 14px; border-radius: 20px; font-weight: 600;
      transition: all .2s ease;
    }
    #deletePageBtn:hover { background: #dc3545; color: #fff; border-color: #dc3545; }
    #deletePageBtn[disabled] { opacity: .5; cursor: not-allowed; }

    /* ===========================
       EDITOR (wrap + scrolling)
       =========================== */
    .editor {
      min-height: 220px;
      max-height: 60vh;            /* prevent it from growing beyond viewport */
      padding: 24px;
      background: #fff;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      font-family: Georgia, 'Times New Roman', Times, serif;
      font-size: 18px;
      line-height: 1.7;
      caret-color: #111;

      /* key wrapping rules so it behaves like a normal textarea */
      white-space: pre-wrap;        /* preserve breaks, wrap long lines */
      overflow-wrap: anywhere;      /* break long words aggressively if needed */
      word-break: break-word;       /* fallback for older engines */
      hyphens: auto;                /* allow hyphenation where supported */
      overflow: auto;               /* scroll when content exceeds max-height */
    }

    /* Focus state for accessibility */
    .editor:focus, .editor:focus-within {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px var(--color-accent-soft), var(--shadow);
    }

    /* Placeholder when empty */
    .editor:empty::before {
      content: attr(data-placeholder);
      color: var(--color-muted);
    }

    /* Typographic defaults inside the editor */
    .editor p { margin: 0 0 1em; }
    .editor p:last-child { margin-bottom: 0; }
    .editor h1, .editor h2, .editor h3 {
      font-family: Georgia, 'Times New Roman', Times, serif;
      font-weight: 700;
      line-height: 1.25;
      margin: 1.2em 0 .6em;
    }
    .editor h2 { font-size: 1.4em; }
    .editor h3 { font-size: 1.2em; }
    .editor ul, .editor ol { margin: .8em 0; padding-left: 1.5em; }
    .editor li { margin: .3em 0; }
    .editor a { color: var(--color-accent); text-decoration: underline; }
    .editor img { max-width: 100%; height: auto; display: block; margin: 1em auto; border-radius: 6px; }

    /* === Image resize overlay === */
    .img-resizer {
      position: fixed; /* follow viewport; we reposition on scroll */
      border: 2px dashed rgba(0,0,0,0.25);
      border-radius: 6px;
      pointer-events: none; /* allow clicks through, except handle */
      z-index: 1000;
    }
    .img-resizer.hidden { display: none; }
    .img-resizer .handle {
      position: absolute;
      width: 14px; height: 14px;
      right: -7px; bottom: -7px; /* half outside the border */
      background: #0ca678; /* teal to match image pill */
      border: 2px solid #fff; box-shadow: 0 1px 4px rgba(0,0,0,.25);
      border-radius: 50%;
      cursor: nwse-resize;
      pointer-events: auto; /* enable grabbing */
    }

    .help { color: var(--color-muted); }

    /* ACTIONS */
    .actions { display: flex; gap: 16px; justify-content: flex-end; margin-top: 32px; }
    .actions .preview {
      border: 1px solid var(--color-text); background: #fff; color: var(--color-text);
      padding: 12px 24px; border-radius: var(--radius); font-weight: 600;
      transition: all .2s;
    }
    .actions .preview:hover { background: #e9ecef; }
    .actions .publish {
      background: var(--color-accent); color: #fff; border: none;
      padding: 12px 24px; border-radius: var(--radius); font-weight: 600;
      transition: background .2s;
    }
    .actions .publish:hover { background: #0056b3; }

    /* small responsive tweaks */
    @media (max-width: 1024px) {
      .app { grid-template-columns: 1fr; }
      .rail { padding: 16px; text-align: center; }
      .main { padding: 16px; }
      .meta-grid { 
        grid-template-columns: 1fr; 
        gap: 20px; 
      }
      .meta-grid .field {
        margin-bottom: 20px;
      }
    }

    @media (max-width: 768px) {
      .meta-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .chips {
        max-height: 60px;
      }
      .file {
        min-height: 60px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="rail">
      <h1>ADMIN</h1>
      <div class="drafts-widget" id="draftsWidget">
        <button class="drafts-icon" id="draftsIcon" title="Drafts">D</button>
        <select id="draftsSort" class="tselect small" title="Sort drafts">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="title">Title Aâ€“Z</option>
        </select>
        <div id="draftsList" class="drafts-list" aria-live="polite"></div>
      </div>
    </aside>
    <main class="main">
      <div class="tabs" id="adminTabs" role="tablist" aria-label="Admin sections">
        <button class="tab" role="tab" aria-selected="true" data-admin="editor">Article Editor</button>
        <button class="tab" role="tab" aria-selected="false" data-admin="spotlights">Spotlights</button>
        <button class="tab" role="tab" aria-selected="false" data-admin="articles">Articles</button>
        <button class="tab" role="tab" aria-selected="false" data-admin="sitemeta">Site Meta</button>
        <div class="toolbar" style="margin-left:auto;">
          <button class="btn" id="chooseWorkspaceBtn" type="button" title="Pick your site folder">Choose Workspace</button>
          <button class="btn" id="githubConfigBtn" type="button" title="GitHub settings & status">GitHub</button>
        </div>
      </div>
      <h2 class="page-title serif" id="pageTitle">Edit Article</h2>
      <!-- GitHub Config Modal -->
      <div id="ghModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:#fff; color:#000; width:520px; max-width:90%; padding:24px 28px 32px; border-radius:16px; box-shadow:0 8px 40px -8px rgba(0,0,0,.4); font-family:system-ui, sans-serif; position:relative;">
          <h3 style="margin:0 0 8px; font-size:20px; letter-spacing:.5px;">GitHub Auto Commit</h3>
          <p style="margin:0 0 16px; font-size:14px; line-height:1.35; color:#444;">Provide a fine-grained Personal Access Token (classic PAT also works) with <strong>contents: read & write</strong> for the target repo. Data is stored locally in your browser only. Commits will run automatically after saves/publishes when Auto Push is enabled.</p>
          <div style="display:grid; gap:12px;">
            <label style="display:grid; gap:4px; font-size:13px;">
              <span>Owner / Org</span>
              <input id="ghOwner" class="input" placeholder="e.g. my-user"/>
            </label>
            <label style="display:grid; gap:4px; font-size:13px;">
              <span>Repository</span>
              <input id="ghRepo" class="input" placeholder="e.g. my-site"/>
            </label>
            <label style="display:grid; gap:4px; font-size:13px;">
              <span>Branch</span>
              <input id="ghBranch" class="input" placeholder="main" value="main"/>
            </label>
            <label style="display:grid; gap:4px; font-size:13px;">
              <span>Base Path in Repo (optional subfolder)</span>
              <input id="ghBasePath" class="input" placeholder="(leave blank if root)"/>
            </label>
            <label style="display:grid; gap:4px; font-size:13px;">
              <span>Token</span>
              <input id="ghToken" class="input" type="password" autocomplete="off" placeholder="ghp_..."/>
            </label>
            <label style="display:flex; align-items:center; gap:8px; font-size:13px;">
              <input id="ghRemember" type="checkbox"/> <span>Remember token (stores in localStorage)</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; font-size:13px;">
              <input id="ghAuto" type="checkbox"/> <span>Auto Push after saves</span>
            </label>
            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:8px;">
              <button id="ghClose" class="btn" type="button">Close</button>
              <button id="ghSave" class="btn" type="button" style="background:#198754; color:#198754; border-color:#198754; color:#fff;">Save</button>
            </div>
            <div id="ghStatus" style="font-size:12px; color:#555; min-height:18px;"></div>
            <div style="font-size:11px; color:#666; line-height:1.3;">Security note: A token placed in client-side code can be extracted by anyone with local access to this browser profile or by malicious scripts running on this page. Prefer a throwaway / contentâ€‘limited token. For higher security, route commits through a small serverless proxy.</div>
          </div>
        </div>
      </div>

  <section class="panel" id="panel-editor" aria-labelledby="form-title">
        <div class="field">
          <label class="label smallcaps" for="headline">Article Title</label>
          <input id="headline" class="input" type="text"/>
        </div>

        <div class="field">
          <label class="label smallcaps" for="author">Author Name</label>
          <input id="author" class="input" type="text" placeholder="e.g. Jane Doe"/>
        </div>

        <div class="meta-grid">
          <div class="field">
            <label class="label smallcaps" for="category">Category</label>
            <select id="category" class="select input">
              <option>Feature</option>
              <option>News</option>
              <option>Opinion</option>
              <option>Sports</option>
              <option>Editorial</option>
              <option>Brief</option>
            </select>
          </div>

          <div class="field">
            <label class="label smallcaps" for="positiontag">Position</label>
            <input id="positiontag" class="input" type="number" min="1" max="999" maxlength="3" placeholder="###"/>
          </div>

          <div class="field">
            <label class="label smallcaps">Tags</label>
            <div class="chip-input">
              <input id="chipText" class="input" type="text" maxlength="20" placeholder="Add a tag and press Enter" />
              <button id="addChip" class="add">+</button>
            </div>
            <div id="chipList" class="chips" aria-live="polite"></div>
          </div>

          <div class="field">
            <label class="label smallcaps">Ft. Image</label>
            <div class="file">
              <button id="chooseFile" class="btn" type="button">Chooseâ€¦</button>
              <input id="fileInput" type="file" accept="image/*" />
              <div class="meta" id="fileMeta">No file selected</div>
            </div>
          </div>
        </div>

        <div class="rule"></div>

  <div class="tabs" id="pageTabs" role="tablist" aria-label="Article pages and tools">
          <button class="tab" role="tab" aria-selected="true" data-tab="pg1">PG.1</button>
          <button id="addPage" class="btn" type="button" title="Add page" aria-label="Add page">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="toolbar">
            <div class="group" role="group" aria-label="Text formatting">
              <button class="pill" data-cmd="bold" aria-pressed="false" title="Bold"><strong>B</strong></button>
              <button class="pill" data-cmd="italic" aria-pressed="false" title="Italic"><em>I</em></button>
              <button class="pill" data-cmd="underline" aria-pressed="false" title="Underline"><span style="text-decoration:underline;">U</span></button>
              <button class="pill" data-cmd="link" aria-pressed="false" title="Link" aria-label="Link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M10.5 13.5l3-3M9 7h6a4 4 0 010 8H9a4 4 0 010-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <select id="blockFormat" class="tselect" title="Block style" aria-label="Block style">
                <option value="p">Normal text</option>
                <option value="h1">Heading 1</option>
                <option value="h2" selected>Heading 2</option>
                <option value="h3">Subheading</option>
              </select>
            </div>
            <span aria-hidden="true" style="width:8px"></span>
            <div class="group" role="group" aria-label="Lists">
              <button class="pill pill-icon" data-cmd="list" aria-pressed="false" title="Bulleted list" aria-label="Bulleted list">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <circle cx="5" cy="7" r="1.5" fill="currentColor"/>
                  <circle cx="5" cy="12" r="1.5" fill="currentColor"/>
                  <circle cx="5" cy="17" r="1.5" fill="currentColor"/>
                  <path d="M9 7h10M9 12h10M9 17h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
              <button class="pill pill-icon" data-cmd="olist" aria-pressed="false" title="Numbered list" aria-label="Numbered list">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <rect x="3.5" y="5.5" width="3" height="3" fill="currentColor"/>
                  <rect x="3.5" y="10.5" width="3" height="3" fill="currentColor"/>
                  <rect x="3.5" y="15.5" width="3" height="3" fill="currentColor"/>
                  <path d="M9 7h10M9 12h10M9 17h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            <div class="group" role="group" aria-label="Alignment">
              <button class="pill pill-icon" data-cmd="align-left" aria-pressed="false" title="Align left" aria-label="Align left">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M4 6h16M4 10h10M4 14h16M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
              <button class="pill pill-icon" data-cmd="align-center" aria-pressed="false" title="Center" aria-label="Center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M4 6h16M7 10h10M4 14h16M7 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
              <button class="pill pill-icon" data-cmd="align-right" aria-pressed="false" title="Align right" aria-label="Align right">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M4 6h16M10 10h10M4 14h16M10 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            <select id="fontSizeSelect" class="tselect" title="Font size (px)">
              <option>12</option>
              <option>14</option>
              <option selected>16</option>
              <option>18</option>
              <option>20</option>
              <option>22</option>
              <option>24</option>
              <option>28</option>
              <option>32</option>
            </select>
            <button class="pill pill-image pill-icon" data-cmd="image" aria-pressed="false" title="Insert image" aria-label="Insert image">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                <path d="M7 15l3-3 4 4 3-3 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="9" cy="9" r="2" fill="currentColor"/>
              </svg>
            </button>
            <button id="deletePageBtn" class="pill pill-icon" title="Delete active page" aria-label="Delete page">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M6 6l1 14a2 2 0 002 2h6a2 2 0 002-2l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>

  <div id="editor" class="editor" contenteditable="true" aria-label="Article content editor" data-placeholder="Start writing your articleâ€¦"></div>
  <!-- Overlay used for resizing selected images -->
  <div id="imgResizer" class="img-resizer hidden" aria-hidden="true"><div class="handle" title="Drag to resize"></div></div>
  <input id="insertImageInput" type="file" accept="image/*" style="display:none" />

        <div class="actions">
          <button class="publish" type="button" id="publishBtn">Finish up</button>
        </div>
      </section>

      <!-- Spotlights Panel -->
      <section class="panel" id="panel-spotlights" hidden>
        <h3 class="serif" style="margin-top:0;">Spotlights</h3>
        <p class="smallcaps">Edit Spotlights.json at the workspace root</p>
        <div class="actions" style="justify-content:flex-start; margin-top:16px;">
          <button class="btn" id="spotlightsLoadBtn" type="button">Load</button>
          <button class="btn" id="spotlightsAddBtn" type="button">Add Spotlight</button>
          <button class="publish" id="spotlightsSaveBtn" type="button">Save Spotlights</button>
        </div>
        <div id="spotlightsList" style="margin-top:16px; display:grid; gap:12px;"></div>
      </section>

      <!-- Published Articles Panel -->
      <section class="panel" id="panel-articles" hidden>
        <h3 class="serif" style="margin-top:0;">Articles</h3>
        <p class="smallcaps">View and manage published articles from ArticleCatalog.json</p>
        <div class="actions" style="justify-content:flex-start; margin-top:16px;">
          <button class="btn" id="catalogLoadBtn" type="button">Reload Catalog</button>
          <button class="btn" id="catalogSaveBtn" type="button">Save Catalog</button>
          <button class="publish" id="publishCurrentBtn" type="button">Publish Current Editor</button>
        </div>
        <div id="publishedList" style="margin-top:16px; display:grid; gap:8px;"></div>
        <div class="rule"></div>
        <h4 class="serif" style="margin:0 0 8px;">Drafts (Local)</h4>
        <div id="draftsPublishList" style="display:grid; gap:8px;"></div>
      </section>

      <!-- Site Meta Panel -->
      <section class="panel" id="panel-sitemeta" hidden>
        <h3 class="serif" style="margin-top:0;">Site Meta</h3>
        <p class="smallcaps">Edit SiteMeta.json at the workspace root</p>
        <div class="actions" style="justify-content:flex-start; margin-top:16px; gap:8px;">
          <button class="btn" id="siteMetaLoadBtn" type="button">Load</button>
          <button class="publish" id="siteMetaSaveBtn" type="button">Save Site Meta</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px;">
          <div style="border:1px solid var(--color-border); border-radius:8px; padding:12px;">
            <h4 class="serif" style="margin:0 0 8px;">Meta</h4>
            <label class="label">Date<input id="smDate" class="input" type="date" /></label>
            <label class="label">Location<input id="smLocation" class="input" type="text" placeholder="City, ST" /></label>
            <label class="label">Unit
              <select id="smUnit" class="select">
                <option value="F">F</option>
                <option value="C">C</option>
              </select>
            </label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <label class="label">Now Temp<input id="smNowTemp" class="input" type="number" step="1" /></label>
              <label class="label">Condition<input id="smNowCond" class="input" type="text" placeholder="Sunny" /></label>
            </div>
            <div id="smPreview" style="margin-top:10px; padding:10px; border:1px dashed var(--color-border); border-radius:6px; font-size:14px; color:var(--color-muted);">
              <div><strong>Meta pill:</strong> <span id="smPreviewPill">â€”</span></div>
              <div style="margin-top:4px;"><strong>Weather:</strong> <span id="smPreviewWeather">â€”</span></div>
            </div>
          </div>
          <div style="border:1px solid var(--color-border); border-radius:8px; padding:12px;">
            <h4 class="serif" style="margin:0 0 8px;">Weather</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <label class="label">High<input id="smHigh" class="input" type="number" step="1" /></label>
              <label class="label">Low<input id="smLow" class="input" type="number" step="1" /></label>
            </div>
            <label class="label">Summary<input id="smSummary" class="input" type="text" placeholder="Partly Cloudy" /></label>
          </div>
        </div>

        <div style="margin-top:16px; display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div style="border:1px solid var(--color-border); border-radius:8px; padding:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
              <h4 class="serif" style="margin:0;">Events</h4>
              <div style="display:flex; gap:6px;">
                <button class="btn" id="evSortBtn" type="button" title="Sort by date">Sort</button>
                <button class="btn" id="evClearPastBtn" type="button" title="Remove past events">Clear past</button>
                <button class="btn" id="addEventBtn" type="button">Add Event</button>
              </div>
            </div>
            <div id="siteMetaEvents" style="margin-top:8px; display:grid; gap:8px;"></div>
          </div>
          <div style="border:1px solid var(--color-border); border-radius:8px; padding:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <h4 class="serif" style="margin:0;">Scores</h4>
              <button class="btn" id="addScoreBtn" type="button">Add Score</button>
            </div>
            <div id="siteMetaScores" style="margin-top:8px; display:grid; gap:8px;"></div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Publish modal -->
  <div id="publishModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="publishModalTitle">
    <div class="modal">
      <header id="publishModalTitle">Finish up</header>
      <div class="content">Save as draft or finish and merge this article into your workspace (you'll choose the folder).</div>
      <div class="actions">
        <button id="modalCancel" class="btn" type="button">Cancel</button>
        <button id="modalDraft" class="btn" type="button">Save as Draft</button>
  <button id="modalPublishNow" class="publish" type="button">Finish up</button>
      </div>
    </div>
  </div>

  
  
  <script>
  // =====================================================
  // Updated JS: keep behavior, add aria-pressed toggles for
  // toolbar pills so CSS can show "in use" styling.
  // Also nothing else destructive changed.
  // =====================================================

  // ---- Chips (Tags) ----
  const chipList = document.getElementById('chipList');
  const chipInput = document.getElementById('chipText');
  const addChipBtn = document.getElementById('addChip');
  const TAG_LIMIT = 5;

  const state = {
    chips: [],
    pages: {
      pg1: ''
    },
    pageTitles: {
      pg1: 'PG.1'
    },
    drafts: [],
    draftsSort: 'newest'
  };

  function updateTagInputState() {
      if (state.chips.length >= TAG_LIMIT) {
          addChipBtn.disabled = true;
          chipInput.disabled = true;
          chipInput.placeholder = 'Max 5 tags reached';
      } else {
          addChipBtn.disabled = false;
          chipInput.disabled = false;
          chipInput.placeholder = 'Add a tag and press Enter';
      }
  }

  function renderChips(){
    chipList.innerHTML = '';
    state.chips.forEach((label, idx)=>{
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = label;
      chip.setAttribute('data-index', idx);
      chip.title = 'Click to toggle accent; Ã— to remove';

      // toggle accent on click
      chip.addEventListener('click', (e)=>{
        const active = chip.getAttribute('data-active') === 'true';
        chip.setAttribute('data-active', (!active).toString());
        e.stopPropagation();
      });

      // remove button
      const close = document.createElement('button');
      close.setAttribute('aria-label', `Remove ${label}`);
      close.textContent = 'Ã—';
      close.addEventListener('click', (e)=>{
        e.stopPropagation();
        state.chips.splice(idx,1); 
        renderChips();
        updateTagInputState();
      });
      chip.appendChild(close);
      chipList.appendChild(chip);
    });
  }
  renderChips();
  updateTagInputState();

  function addChip(){
    const val = chipInput.value.trim();
    if(!val || state.chips.length >= TAG_LIMIT) {
        return;
    }
    if(!state.chips.includes(val)) state.chips.push(val);
    chipInput.value='';
    renderChips();
    updateTagInputState();
  }
  addChipBtn.addEventListener('click', addChip);
  chipInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addChip(); }});

  // ---- Position Tag Input Validation ----
  const positionInput = document.getElementById('positiontag');
  positionInput.addEventListener('input', (e) => {
    // Ensure only 3 digits maximum
    let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
    if (value.length > 3) {
      value = value.slice(0, 3);
    }
    e.target.value = value;
  });

  // ---- File input meta ----
  const chooseFile = document.getElementById('chooseFile');
  const fileInput  = document.getElementById('fileInput');
  const fileMeta   = document.getElementById('fileMeta');

  chooseFile.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', ()=>{
    const f = fileInput.files && fileInput.files[0];
    if(!f){ fileMeta.textContent = 'No file selected'; return; }
    const sizeKB = Math.round(f.size/1024);
    // Try to read dimensions
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = () => {
      fileMeta.textContent = `${f.name} â€¢ ${img.width}Ã—${img.height} â€¢ ${sizeKB} kB`;
      URL.revokeObjectURL(url);
    };
    img.onerror = () => {
      fileMeta.textContent = `${f.name} â€¢ ${sizeKB} kB`;
      URL.revokeObjectURL(url);
    };
    img.src = url;
  });

  // ---- Tabs & basic editor state per page ----
  const editor = document.getElementById('editor');
  const tablist = document.getElementById('pageTabs');

  // ---- Toolbar element cache ----
  const btnBold = document.querySelector('.pill[data-cmd="bold"]');
  const btnItalic = document.querySelector('.pill[data-cmd="italic"]');
  const btnUnderline = document.querySelector('.pill[data-cmd="underline"]');
  const btnLink = document.querySelector('.pill[data-cmd="link"]');
  const btnList = document.querySelector('.pill[data-cmd="list"]');
  const btnOList = document.querySelector('.pill[data-cmd="olist"]');
  const btnAlignLeft = document.querySelector('.pill[data-cmd="align-left"]');
  const btnAlignCenter = document.querySelector('.pill[data-cmd="align-center"]');
  const btnAlignRight = document.querySelector('.pill[data-cmd="align-right"]');
  const fontSizeSelect = document.getElementById('fontSizeSelect');
  const blockFormat = document.getElementById('blockFormat');

  // ---- Helpers ----
  function getSelectionContainer(){
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) return null;
    const node = sel.anchorNode;
    return node && node.nodeType === 1 ? node : node ? node.parentElement : null;
  }
  function getNearestBlock(node){
    let el = node && (node.nodeType === 1 ? node : node.parentElement);
    while (el && el !== editor){
      if (el.tagName && /^(P|H1|H2|H3|DIV|LI|UL|OL|BLOCKQUOTE)$/i.test(el.tagName)) return el;
      el = el.parentElement;
    }
    return editor; // fallback so we always have a container
  }
  function setPressed(el, on){ if (el) el.setAttribute('aria-pressed', on ? 'true' : 'false'); }
  function updateToolbarStates(){
    try {
      setPressed(btnBold, document.queryCommandState('bold'));
      setPressed(btnItalic, document.queryCommandState('italic'));
      setPressed(btnUnderline, document.queryCommandState('underline'));
      setPressed(btnList, document.queryCommandState('insertUnorderedList'));
      setPressed(btnOList, document.queryCommandState('insertOrderedList'));

      // Alignment based on nearest block's computed style
      const node = getSelectionContainer();
      const block = getNearestBlock(node);
  let align = block ? (getComputedStyle(block).textAlign || 'left') : 'left';
      // Normalize values like start/end and justify
      if(align === 'start') align = 'left';
      if(align === 'end') align = 'right';
  if(align === 'justify') align = 'center'; // treat justify as center highlight for lack of dedicated button
      setPressed(btnAlignLeft, align === 'left');
      setPressed(btnAlignCenter, align === 'center');
      setPressed(btnAlignRight, align === 'right');

      // Sync selects
      if (fontSizeSelect) {
        const refNode = node;
        let el = refNode;
        let px = 16;
        while (el && el !== editor) {
          const cs = window.getComputedStyle(el);
          const n = parseFloat(cs.fontSize);
          if (!isNaN(n)) { px = n; break; }
          el = el.parentElement;
        }
        const options = Array.from(fontSizeSelect.options).map(o=>parseInt(o.value,10));
        let closest = options[0];
        options.forEach(v=>{ if (Math.abs(v-px) < Math.abs(closest-px)) closest = v; });
        fontSizeSelect.value = String(closest);
      }
      if (blockFormat) {
        const blockEl = getNearestBlock(getSelectionContainer());
        const tag = (blockEl?.tagName || 'P').toLowerCase();
        if (/^(p|h1|h2|h3)$/.test(tag)) blockFormat.value = tag; else blockFormat.value = 'p';
      }
    } catch {}
  }

  function isDefaultTitle(title){
    return /^PG\.\d+$/.test(title || '');
  }

  function currentTab(){
    return tablist.querySelector('.tab[aria-selected="true"]').dataset.tab;
  }

  function switchTo(tabId){
    // Save current content
  const cur = tablist.querySelector('.tab[aria-selected="true"]')?.dataset.tab;
    if (cur) {
      state.pages[cur] = editor.innerHTML;
    }

    // Update selection
    tablist.querySelectorAll('.tab').forEach(t=>{
      t.setAttribute('aria-selected', t.dataset.tab===tabId ? 'true' : 'false');
    });
    editor.innerHTML = state.pages[tabId] || '';
  }

  tablist.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab');
    if(!btn) return;
    if(btn.getAttribute('aria-selected')==='true') return;
    switchTo(btn.dataset.tab);
  });

  // Inline rename on double-click (contenteditable)
  tablist.addEventListener('dblclick', (e)=>{
    const btn = e.target.closest('.tab');
    if(!btn) return;
    const id = btn.dataset.tab;
    // Prevent multiple edits at once
    if (btn.getAttribute('contenteditable') === 'true') return;

    const prev = btn.textContent || state.pageTitles[id] || '';
    btn.setAttribute('contenteditable','true');
    btn.setAttribute('spellcheck','false');
    // Place caret at end
    const range = document.createRange();
    range.selectNodeContents(btn);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges(); sel.addRange(range);
    btn.focus();

    let canceled = false;
    function commit() {
      btn.removeAttribute('contenteditable');
      let text = (btn.textContent || '').trim();
      if (!text) text = prev; // revert empty
      btn.textContent = text;
      state.pageTitles[id] = text;
      btn.removeEventListener('keydown', onKey);
      btn.removeEventListener('blur', onBlur);
    }
    function cancel() {
      canceled = true;
      btn.removeAttribute('contenteditable');
      btn.textContent = prev;
      btn.removeEventListener('keydown', onKey);
      btn.removeEventListener('blur', onBlur);
    }
    function onKey(ev){
      if (ev.key === 'Enter') { ev.preventDefault(); commit(); }
      else if (ev.key === 'Escape') { ev.preventDefault(); cancel(); }
    }
    function onBlur(){ if (!canceled) commit(); }
    btn.addEventListener('keydown', onKey);
    btn.addEventListener('blur', onBlur);
  });

  // ---- Add new page logic ----
  const addPageBtn = document.getElementById('addPage');
  addPageBtn.addEventListener('click', ()=>{
    const tabs = tablist.querySelectorAll('.tab');
    let maxNum = 0;
    tabs.forEach(tab => {
        const num = parseInt(tab.dataset.tab.replace('pg', '')) || 0;
        if (num > maxNum) {
            maxNum = num;
        }
    });
    const nextNum = maxNum + 1;
    const id = `pg${nextNum}`;
  
    const newTab = document.createElement('button');
    newTab.className='tab';
    newTab.type='button';
    newTab.setAttribute('role','tab');
    newTab.setAttribute('aria-selected','false');
    newTab.dataset.tab = id;
    newTab.textContent = `PG.${nextNum}`;
    tablist.insertBefore(newTab, addPageBtn);
    state.pages[id] = '';
    state.pageTitles[id] = newTab.textContent;
    switchTo(id);
    updateDeleteButtonState();
  });

  // Single Delete button: deletes the currently active page
  const deletePageBtn = document.getElementById('deletePageBtn');
  deletePageBtn.addEventListener('click', ()=>{
    const active = tablist.querySelector('.tab[aria-selected="true"]');
    if(!active) return;
    deletePage(active.dataset.tab);
  });

  function updateDeleteButtonState(){
  const tabs = tablist.querySelectorAll('.tab');
    if(tabs.length <= 1){ deletePageBtn.setAttribute('disabled',''); }
    else { deletePageBtn.removeAttribute('disabled'); }
  }

  // initial state
  updateDeleteButtonState();

  // ---- Delete page logic ----
  function deletePage(tabId) {
  const tabs = Array.from(tablist.querySelectorAll('.tab'));
    if (tabs.length <= 1) {
      alert('Cannot delete the only page.');
      return;
    }

  const tabEl = tablist.querySelector(`.tab[data-tab="${tabId}"]`);
  const label = (tabEl?.textContent || tabId.toUpperCase().replace('PG','PG.'));
  const ok = confirm(`Delete ${label}? This will remove the page and its content.`);
    if (!ok) return;

    // Save the content of the active tab before deletion
    const currentActiveTabId = currentTab();
    state.pages[currentActiveTabId] = editor.innerHTML;

    // Remove the page from the state
    delete state.pages[tabId];

    // Find the tab element and its position
    const wasActive = tabEl?.getAttribute('aria-selected') === 'true';
    const tabIndex = tabs.findIndex(t => t.dataset.tab === tabId);

    if (tabEl) tabEl.remove();

    // Rebuild pages object and re-number tabs to keep pg1..pgN contiguous
  const remainingTabs = Array.from(tablist.querySelectorAll('.tab'));
    const newPages = {};
    const newTitles = {};
    remainingTabs.forEach((t, idx) => {
      const oldId = t.dataset.tab;
      const newId = `pg${idx + 1}`;
      const oldTitle = state.pageTitles?.[oldId] ?? t.textContent ?? '';
      const updatedTitle = isDefaultTitle(oldTitle) ? `PG.${idx+1}` : oldTitle;
      t.dataset.tab = newId;
      t.textContent = updatedTitle;
      newPages[newId] = state.pages[oldId] || '';
      newTitles[newId] = updatedTitle;
    });

    state.pages = newPages;
    state.pageTitles = newTitles;

    // Determine which tab to select next
    if (wasActive) {
      let nextTabIndex = Math.min(tabIndex, remainingTabs.length - 1);
      const nextTab = remainingTabs[nextTabIndex];
      if (nextTab) {
        switchTo(nextTab.dataset.tab);
      } else {
        editor.innerHTML = '';
      }
    }
    updateDeleteButtonState();
  }

  // ---- Toolbar commands (improved: reflect pressed state) ----
  document.querySelectorAll('.pill').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const cmd = btn.dataset.cmd;
      if(cmd==='bold') {
        document.execCommand('bold');
        // queryCommandState tells us whether bold is now active at caret
        const stateOn = document.queryCommandState('bold');
        btn.setAttribute('aria-pressed', stateOn ? 'true' : 'false');
      }
      else if(cmd==='italic') {
        document.execCommand('italic');
        const stateOn = document.queryCommandState('italic');
        btn.setAttribute('aria-pressed', stateOn ? 'true' : 'false');
      }
      else if(cmd==='h2') {
        document.execCommand('formatBlock', false, 'h2');
        // not a toggle; ensure aria-pressed is false
        btn.setAttribute('aria-pressed', 'false');
      }
      else if(cmd==='link'){
        const sel = window.getSelection();
        if (!sel) return;
        const range = sel.rangeCount ? sel.getRangeAt(0) : null;
        const node = sel.anchorNode ? (sel.anchorNode.nodeType === 1 ? sel.anchorNode : sel.anchorNode.parentElement) : null;
        const anchor = node ? (node.closest && node.closest('a')) : null;
        // If selection fully within an anchor OR anchor is selected, toggle unlink immediately
        if (anchor && range && (anchor.contains(range.commonAncestorContainer) || anchor === range.commonAncestorContainer)) {
          document.execCommand('unlink');
        } else if (range && !range.collapsed) {
          const url = prompt('Link URL:', 'https://');
          if (url) document.execCommand('createLink', false, url);
        } else {
          const url = prompt('Link URL:', 'https://');
          if (url) {
            const text = prompt('Text to display (optional):', url) || url;
            const a = document.createElement('a');
            a.href = url;
            a.textContent = text;
            const r = sel.getRangeAt(0);
            r.insertNode(a);
            r.setStartAfter(a);
            r.setEndAfter(a);
            sel.removeAllRanges(); sel.addRange(r);
          }
        }
        btn.setAttribute('aria-pressed', 'false');
      } else if(cmd==='list'){
        // ensure ordered list is off first
        if (document.queryCommandState('insertOrderedList')) document.execCommand('insertOrderedList');
        document.execCommand('insertUnorderedList');
        const stateOn = document.queryCommandState('insertUnorderedList');
        btn.setAttribute('aria-pressed', stateOn ? 'true' : 'false');
      } else if (cmd==='olist') {
        // ensure unordered list is off first
        if (document.queryCommandState('insertUnorderedList')) document.execCommand('insertUnorderedList');
        document.execCommand('insertOrderedList');
        btn.setAttribute('aria-pressed', document.queryCommandState('insertOrderedList') ? 'true' : 'false');
      } else if (cmd==='underline') {
        document.execCommand('underline');
        btn.setAttribute('aria-pressed', document.queryCommandState('underline') ? 'true' : 'false');
      } else if (cmd==='align-left') {
        document.execCommand('justifyLeft');
        updateToolbarStates();
      } else if (cmd==='align-center') {
        document.execCommand('justifyCenter');
        updateToolbarStates();
      } else if (cmd==='align-right') {
        document.execCommand('justifyRight');
        updateToolbarStates();
      } else if (cmd==='indent') {
        document.execCommand('indent');
        btn.setAttribute('aria-pressed', 'false');
      } else if (cmd==='outdent') {
        document.execCommand('outdent');
        btn.setAttribute('aria-pressed', 'false');
      } else if (cmd==='font-bigger' || cmd==='font-smaller') {
        // adjust font size by wrapping selection in a span with inline font-size
        const sel = window.getSelection();
        if (sel && sel.rangeCount) {
          const range = sel.getRangeAt(0);
          // If selection is collapsed, expand to word for convenience
          if (range.collapsed) {
            const wordRange = range.cloneRange();
            wordRange.expand?.('word'); // optional in some browsers
          }
          const span = document.createElement('span');
          span.style.display = 'inline';
          // Determine current size by checking computed style on parent
          const container = range.commonAncestorContainer.nodeType === 1 ? range.commonAncestorContainer : range.commonAncestorContainer.parentElement;
          const cs = container ? window.getComputedStyle(container) : null;
          const basePx = cs ? parseFloat(cs.fontSize) || 16 : 16;
          const delta = cmd==='font-bigger' ? 2 : -2;
          const newPx = Math.max(10, Math.min(48, Math.round(basePx + delta)));
          span.style.fontSize = newPx + 'px';
          try {
            // surroundContents fails if selection spans multiple elements; fallback to execCommand
            range.surroundContents(span);
          } catch {
            document.execCommand('fontSize', false, '4'); // fallback then adjust via post-process
          }
        }
        btn.setAttribute('aria-pressed', 'false');
      } else if(cmd==='image') {
        // trigger hidden file input to choose an image
        document.getElementById('insertImageInput').click();
        btn.setAttribute('aria-pressed', 'false');
      }
      editor.focus();
    });
  });

  // Reset toolbar pressed states when selection changes (best-effort)
  document.addEventListener('selectionchange', ()=>{
    updateToolbarStates();
  });

  // ---- Toolbar dropdowns ----


  // Map font tag sizes to pixel scale as browsers do with execCommand('fontSize')
  const FONT_SIZE_MAP = { 1: 10, 2: 13, 3: 16, 4: 18, 5: 24, 6: 32, 7: 48 };

  function replaceFontTagsWithPx(root) {
    // Replace <font size="N"> with spans having explicit pixel font-size
    root.querySelectorAll('font[size]').forEach(font=>{
      const n = parseInt(font.getAttribute('size'), 10);
      const px = FONT_SIZE_MAP[n] || 16;
      const span = document.createElement('span');
      span.style.fontSize = px + 'px';
      // move children
      while (font.firstChild) span.appendChild(font.firstChild);
      font.parentNode.replaceChild(span, font);
    });
  }

  function applyFontSizePx(px) {
    px = Math.max(10, Math.min(48, px|0));
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    if (range.collapsed) {
      // If collapsed, insert a zero-width space wrapped in span and set size so typing continues at that size
      const span = document.createElement('span');
      span.style.fontSize = px + 'px';
      span.appendChild(document.createTextNode('\u200B'));
      range.insertNode(span);
      // move caret inside span
      const newRange = document.createRange();
      newRange.setStart(span.firstChild, 1);
      newRange.collapse(true);
      sel.removeAllRanges(); sel.addRange(newRange);
    } else {
      // Use execCommand fontSize to create <font> wrappers, then normalize to px spans
      document.execCommand('fontSize', false, '4');
      // Now walk selection container and replace <font> tags with px spans
      const container = range.commonAncestorContainer.nodeType === 1 ? range.commonAncestorContainer : range.commonAncestorContainer.parentElement;
      replaceFontTagsWithPx(container);
      // Finally, adjust spans to the requested px (overriding default 18px from size 4)
      const selectedSpans = container.querySelectorAll('span[style*="font-size"]');
      selectedSpans.forEach(s=>{ s.style.fontSize = px + 'px'; });
    }
  }

  if (fontSizeSelect) {
    fontSizeSelect.addEventListener('change', () => {
      const px = parseInt(fontSizeSelect.value,10);
      if (!isNaN(px)) applyFontSizePx(px);
      editor.focus();
      document.dispatchEvent(new Event('selectionchange'));
    });
  }

  if (blockFormat) {
    blockFormat.addEventListener('change', () => {
      const tag = blockFormat.value;
      if (tag === 'p') document.execCommand('formatBlock', false, 'p');
      else if (tag === 'h1') document.execCommand('formatBlock', false, 'h1');
      else if (tag === 'h2') document.execCommand('formatBlock', false, 'h2');
      else if (tag === 'h3') document.execCommand('formatBlock', false, 'h3');
      editor.focus();
      document.dispatchEvent(new Event('selectionchange'));
    });
  }

  // ---- Insert image logic ----
  const insertImageInput = document.getElementById('insertImageInput');
  insertImageInput.addEventListener('change', () => {
    const file = insertImageInput.files && insertImageInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
  const dataUrl = typeof reader.result === 'string' ? reader.result : '';
      // Ask for alt text
      const alt = prompt('Alt text (optional, improves accessibility):', '');
      // Create image element
      const img = document.createElement('img');
  img.src = dataUrl;
      if (alt) img.alt = alt;
      // Insert at caret
      editor.focus();
      const sel = window.getSelection();
      if (sel && sel.rangeCount > 0) {
        const range = sel.getRangeAt(0);
        range.collapse(false);
        range.insertNode(img);
        // Move caret after the image by inserting a trailing space/paragraph
        const spacer = document.createTextNode('\u00A0');
        img.after(spacer);
        range.setStartAfter(spacer);
        range.setEndAfter(spacer);
        sel.removeAllRanges();
        sel.addRange(range);
      } else {
        editor.appendChild(img);
      }
      // reset input so the same file can be chosen again if needed
      insertImageInput.value = '';
    };
    reader.readAsDataURL(file);
  });

  // ---- Hotkeys for editor ----
  function isInEditor() {
    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) return false;
    const node = sel.anchorNode instanceof Element ? sel.anchorNode : sel.anchorNode?.parentElement;
    return node ? editor.contains(node) : false;
  }

  document.addEventListener('keydown', (e) => {
    const mod = e.ctrlKey || e.metaKey; // support Cmd on macOS
    if (!mod) return;
    if (!isInEditor()) return;

    // Map shortcuts
    // Ctrl/Cmd+B -> Bold
    if (e.key.toLowerCase() === 'b') {
      e.preventDefault();
      document.execCommand('bold');
      document.dispatchEvent(new Event('selectionchange'));
      return;
    }
    // Ctrl/Cmd+I -> Italic
    if (e.key.toLowerCase() === 'i') {
      e.preventDefault();
      document.execCommand('italic');
      document.dispatchEvent(new Event('selectionchange'));
      return;
    }
    // Ctrl/Cmd+K -> Link
    if (e.key.toLowerCase() === 'k') {
      e.preventDefault();
      const url = prompt('Link URL:');
      if (url) document.execCommand('createLink', false, url);
      document.dispatchEvent(new Event('selectionchange'));
      return;
    }
    // Ctrl/Cmd+2 -> H2
    if (e.key === '2') {
      e.preventDefault();
      document.execCommand('formatBlock', false, 'h2');
      document.dispatchEvent(new Event('selectionchange'));
      return;
    }
    // Ctrl/Cmd+Shift+8 -> Unordered list (like Google Docs)
    if (e.shiftKey && e.key === '8') {
      e.preventDefault();
      document.execCommand('insertUnorderedList');
      document.dispatchEvent(new Event('selectionchange'));
      return;
    }
    // Ctrl/Cmd+Shift+7 -> Ordered list
    if (e.shiftKey && e.key === '7') {
      e.preventDefault();
      document.execCommand('insertOrderedList');
      document.dispatchEvent(new Event('selectionchange'));
      return;
    }
  });

  // ---- Image resizing (keep centered & proportional) ----
  const resizer = document.getElementById('imgResizer');
  const resizerHandle = resizer.querySelector('.handle');
  let activeImg = null;
  let startX = 0, startY = 0;
  let startWidth = 0, startHeight = 0, aspect = 1;

  function getEditorRect() { return editor.getBoundingClientRect(); }

  function positionOverlay() {
    if (!activeImg) return;
    const rect = activeImg.getBoundingClientRect();
    resizer.style.left = rect.left + 'px';
    resizer.style.top = rect.top + 'px';
    resizer.style.width = rect.width + 'px';
    resizer.style.height = rect.height + 'px';
  }

  function showOverlay(img) {
    activeImg = img;
    resizer.classList.remove('hidden');
    resizer.setAttribute('aria-hidden', 'false');
    positionOverlay();
  }

  function hideOverlay() {
    activeImg = null;
    resizer.classList.add('hidden');
    resizer.setAttribute('aria-hidden', 'true');
  }

  // Select image on click to enable resize
  editor.addEventListener('click', (e) => {
    const img = e.target instanceof HTMLImageElement ? e.target : e.target.closest('img');
    if (img) {
      showOverlay(img);
      e.stopPropagation();
    } else {
      hideOverlay();
    }
  });

  // Keep overlay aligned on scroll/resize
  ['scroll', 'resize'].forEach(evt => window.addEventListener(evt, positionOverlay, { passive: true }));

  // Start drag
  resizerHandle.addEventListener('mousedown', (e) => {
    if (!activeImg) return;
    e.preventDefault();
    // compute starting positions
    const rect = activeImg.getBoundingClientRect();
    startX = e.clientX;
    startY = e.clientY;
    startWidth = rect.width;
    startHeight = rect.height;
    aspect = startWidth / startHeight || 1;

    // mousemove / mouseup listeners
    const onMove = (ev) => {
      ev.preventDefault();
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      // scale based on horizontal movement for stability
      let newWidth = Math.max(80, startWidth + dx);
      let newHeight = Math.round(newWidth / aspect);

      // Clamp to editor width
      const edRect = getEditorRect();
      const maxWidth = edRect.width - 32; // small padding allowance
      if (newWidth > maxWidth) {
        newWidth = maxWidth;
        newHeight = Math.round(newWidth / aspect);
      }

      // Apply size in px, keep image centered via margin auto
      activeImg.style.width = newWidth + 'px';
      activeImg.style.height = newHeight + 'px';
      activeImg.style.display = 'block';
      activeImg.style.marginLeft = 'auto';
      activeImg.style.marginRight = 'auto';

      // Reposition overlay to match
      positionOverlay();
    };
    const onUp = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      positionOverlay();
    };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp, { once: true });
  });

  // ---- Actions ----

  document.getElementById('publishBtn').addEventListener('click', ()=>{
    // Open modal for finish/merge
    openPublishModal();
  });

  // ---- Drafts & Publish modal ----
  const publishModal = document.getElementById('publishModal');
  const modalCancel = document.getElementById('modalCancel');
  const modalDraft = document.getElementById('modalDraft');
  const modalPublishNow = document.getElementById('modalPublishNow');
  // removed HTML/Markdown export and split option
  const draftsListEl = document.getElementById('draftsList');
  const draftsSortEl = document.getElementById('draftsSort');

  function openPublishModal(){
    publishModal.setAttribute('aria-hidden','false');
  }
  function closePublishModal(){
    publishModal.setAttribute('aria-hidden','true');
  }

  // ---- Export helpers ----
  function toSafeSlug(str){
    return (str||'untitled')
      .trim()
      .toLowerCase()
      .replace(/[^a-z0-9\s-_]/g,'')
      .replace(/\s+/g,'-')
      .replace(/-+/g,'-')
      .replace(/^-|-$/g,'') || 'untitled';
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  function buildFullHtmlDoc({ title, category, tags, position, pages, pageTitles }){
    const head = `<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">`
      + `<title>${escapeHtml(title||'Untitled')}</title>`
      + `</head><body>`;
    const header = `<header><h1>${escapeHtml(title||'Untitled')}</h1>${category?`<div>Category: ${escapeHtml(category)}</div>`:''}${position?`<div>Position: ${escapeHtml(position)}</div>`:''}${(tags&&tags.length)?`<div>Tags: ${tags.map(escapeHtml).join(', ')}</div>`:''}</header>`;
    const body = Object.keys(pages).sort((a,b)=>parseInt(a)-parseInt(b)).map(id=>{
      const pt = pageTitles?.[id] || `Page ${id}`;
      const html = pages[id] || '';
      return `<section><h2>${escapeHtml(pt)}</h2>${html}</section>`;
    }).join('\n');
    const foot = `</body></html>`;
    return head + header + body + foot;
  }

  function htmlFragmentToMarkdown(html){
    const div = document.createElement('div');
    div.innerHTML = html;
    const lines = [];

    function inlineToMd(el){
      let md = '';
      el.childNodes.forEach(n=>{
        if (n.nodeType === Node.TEXT_NODE) {
          md += n.nodeValue.replace(/\s+/g,' ');
        } else if (n.nodeType === Node.ELEMENT_NODE) {
          const t = n.tagName.toLowerCase();
          if (t === 'strong' || t === 'b') md += '**' + inlineToMd(n) + '**';
          else if (t === 'em' || t === 'i') md += '_' + inlineToMd(n) + '_';
          else if (t === 'u') md += inlineToMd(n);
          else if (t === 'a') {
            const href = n.getAttribute('href') || '';
            md += '[' + inlineToMd(n) + '](' + href + ')';
          }
          else if (t === 'br') md += '  \n';
          else if (t === 'img') {
            const alt = n.getAttribute('alt') || '';
            const src = n.getAttribute('src') || '';
            md += `![${alt}](${src})`;
          }
          else md += inlineToMd(n);
        }
      });
      return md.trim();
    }

    function blockToMd(node){
      const tag = node.tagName?.toLowerCase();
      if (!tag) return;
      if (tag === 'h1' || tag === 'h2' || tag === 'h3') {
        const hashes = {h1:'# ', h2:'## ', h3:'### '}[tag];
        lines.push('\n' + hashes + node.textContent.trim() + '\n');
        return;
      }
      if (tag === 'p') { lines.push('\n' + inlineToMd(node) + '\n'); return; }
      if (tag === 'ul') { Array.from(node.children).forEach(li=> lines.push('- ' + inlineToMd(li))); lines.push('\n'); return; }
      if (tag === 'ol') {
        let i = 1; Array.from(node.children).forEach(li=> lines.push((i++) + '. ' + inlineToMd(li))); lines.push('\n'); return;
      }
      if (tag === 'img') { const alt=node.getAttribute('alt')||''; const src=node.getAttribute('src')||''; lines.push(`![${alt}](${src})`); return; }
      Array.from(node.childNodes).forEach(n=>{ if (n.nodeType===Node.ELEMENT_NODE) blockToMd(n); else if (n.nodeType===Node.TEXT_NODE) lines.push(n.nodeValue);});
    }

    Array.from(div.childNodes).forEach(n=>{ if (n.nodeType===Node.ELEMENT_NODE) blockToMd(n); else if (n.nodeType===Node.TEXT_NODE) lines.push(n.nodeValue); });
    return lines.join('\n').replace(/\n{3,}/g,'\n\n').trim();
  }

  async function saveFile(name, content, type='text/plain'){
    const blob = new Blob([content], { type });
    try {
      if (window.showSaveFilePicker) {
        const ext = name.split('.').pop();
        const pickerOpts = { suggestedName: name, types: [{ description: type, accept: { [type]: ['.'+ext] } }] };
        const handle = await window.showSaveFilePicker(pickerOpts);
        const writable = await handle.createWritable();
        await writable.write(blob);
        await writable.close();
        return;
      }
    } catch {}
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  async function saveMultipleFiles(files){
    if (window.showDirectoryPicker) {
      try {
        const dir = await window.showDirectoryPicker();
        for (const f of files) {
          const handle = await dir.getFileHandle(f.name, { create: true });
          const writable = await handle.createWritable();
          await writable.write(new Blob([f.content], { type: f.type }));
          await writable.close();
        }
        return;
      } catch {}
    }
    for (const f of files) await saveFile(f.name, f.content, f.type);
  }

  // ---- Finish & Merge helpers (File System Access API) ----
  async function ensureDir(root, path){
    const parts = path.split('/').filter(Boolean);
    let dir = root; for (const p of parts) { dir = await dir.getDirectoryHandle(p, { create:true }); }
    return dir;
  }
  async function writeFile(root, path, blobOrText){
    const parts = path.split('/').filter(Boolean); const fileName = parts.pop();
    const dir = parts.length ? await ensureDir(root, parts.join('/')) : root;
    const fh = await dir.getFileHandle(fileName, { create:true });
    const w = await fh.createWritable();
    await w.write(blobOrText instanceof Blob ? blobOrText : new Blob([blobOrText], { type: 'application/json' }));
    await w.close();
  }
  function bumpVersion(v){
    const m = /^([0-9]+)\.([0-9]+)$/.exec(String(v||''));
    if (!m) return '1.0';
    const major = parseInt(m[1],10); const minor = parseInt(m[2],10);
    return `${major}.${minor+1}`;
  }
  async function readJsonIfExists(root, path){
    try {
      const parts = path.split('/').filter(Boolean); const fileName = parts.pop();
      let dir = root; for (const p of parts) { dir = await dir.getDirectoryHandle(p, { create:false }); }
      const fh = await dir.getFileHandle(fileName, { create:false });
      const f = await fh.getFile();
      const text = await f.text();
      return JSON.parse(text);
    } catch { return null; }
  }
  function htmlToMarkdownFromEditor(html){
    return buildMarkdownDoc({ title:'', category:'', tags:[], position:'', pages:{ pg1: html }, pageTitles:{ pg1: '' } }).replace(/^#\s*\n?/, '');
  }
  async function finishAndMerge(){
    // Capture state
    state.pages[currentTab()] = editor.innerHTML;
    const payload = collectPayload();
    const nowIso = new Date().toISOString();
    const baseSlug = toSafeSlug(payload.title) || 'untitled';
    const id = `${nowIso.slice(0,10).replace(/-/g,'')}-${baseSlug}`;
    // Choose or reuse workspace root
    let root = workspaceRoot;
    if (!root) { try { await restoreWorkspace(); root = workspaceRoot; } catch {} }
    if (!root) {
      if (!window.showDirectoryPicker) { alert('Your browser does not support writing files. Use a Chromium-based browser.'); return; }
      const picked = await window.showDirectoryPicker();
      if (!picked) return;
      const ok = await verifyPermission(picked, 'readwrite');
      if (!ok) { alert('Permission denied for this folder.'); return; }
      root = picked; workspaceRoot = picked; try { await idbPut('workspace', picked); } catch {}
    } else {
      const ok = await verifyPermission(root, 'readwrite');
      if (!ok) { alert('No permission to write to the chosen workspace. Please choose again.'); return; }
    }

    // Featured image
    const cover = document.getElementById('fileInput');
    const coverFile = cover?.files && cover.files[0] ? cover.files[0] : null;
    const coverName = coverFile ? coverFile.name : '';
    const coverPath = coverFile ? `media/${coverName}` : '';

    // Read and merge ArticleCatalog.json
    const catalogPath = 'ArticleCatalog.json';
    const catalog = (await readJsonIfExists(root, catalogPath)) || { articles: [], version:'1.0' };
    const entry = {
      id,
      title: payload.title || 'Untitled',
      tags: Array.isArray(payload.tags)?payload.tags:[],
      category: payload.category || (payload.tags && payload.tags[0]) || 'NEWS',
      time_posted: nowIso,
      homepage_position: payload.position || '',
      imageUrl: coverPath,
      imageAlt: ''
    };
    const idx = (catalog.articles||[]).findIndex(a=>String(a.id)===String(id));
    if (idx>=0) catalog.articles[idx] = { ...(catalog.articles[idx]||{}), ...entry };
    else (catalog.articles||[]).push(entry);
    catalog.last_updated = nowIso;
    catalog.version = bumpVersion(catalog.version);

    // Build article JSON with pages (markdown + html)
    const pageIds = Object.keys(payload.pages||{}).sort((a,b)=>parseInt(a.replace('pg',''))-parseInt(b.replace('pg','')));
    const pages = pageIds.map((pid, i)=>{
      const html = String(payload.pages[pid]||'');
      const markdown = htmlToMarkdownFromEditor(html);
      const title = payload.pageTitles?.[pid] || (i?`Page ${i+1}`:'');
      return { title, markdown, html };
    });
    const articleObj = {
      id,
      title: payload.title||'Untitled',
      category: entry.category,
      tags: entry.tags,
      hero: coverFile?{ src: coverPath, alt: '' }:undefined,
      pages
    };

    // Write files
    await writeFile(root, catalogPath, JSON.stringify(catalog, null, 2));
    await writeFile(root, `articles/${id}.json`, JSON.stringify(articleObj, null, 2));
    if (coverFile) { await writeFile(root, coverPath, coverFile); }

    alert('Finished and merged into workspace.\n\nUpdated: ArticleCatalog.json\nAdded: articles/'+id+'.json'+(coverFile?`\nAdded: ${coverPath}`:''));
    closePublishModal();
  }
  function buildMarkdownDoc(payload){
    const parts = [];
    const title = payload.title?.trim() || 'Untitled';
    parts.push('# ' + title);
    if (payload.category) parts.push('\nCategory: ' + payload.category);
    if (payload.position) parts.push('Position: ' + payload.position);
    if (payload.tags?.length) parts.push('Tags: ' + payload.tags.join(', '));
    parts.push('');
    const ids = Object.keys(payload.pages).sort((a,b)=>parseInt(a)-parseInt(b));
    for (const id of ids) {
      const pt = payload.pageTitles?.[id] || `Page ${id}`;
      parts.push('\n## ' + pt + '\n');
      const md = htmlFragmentToMarkdown(payload.pages[id] || '');
      if (md) parts.push(md);
    }
    return parts.join('\n').replace(/\n{3,}/g,'\n\n').trim() + '\n';
  }
  modalCancel.addEventListener('click', closePublishModal);
  publishModal.addEventListener('click', (e)=>{
    if (e.target === publishModal) closePublishModal();
  });

  function collectPayload(){
    // Save current page before collection
    state.pages[currentTab()] = editor.innerHTML;
    return {
      title: document.getElementById('headline').value,
      author: document.getElementById('author').value,
      category: document.getElementById('category').value,
      tags: state.chips,
      position: document.getElementById('positiontag').value,
      pages: { ...state.pages },
      pageTitles: { ...state.pageTitles },
      createdAt: Date.now()
    };
  }

  function renderDrafts(){
    const items = [...state.drafts];
    if (state.draftsSort === 'newest') items.sort((a,b)=>b.createdAt - a.createdAt);
    else if (state.draftsSort === 'oldest') items.sort((a,b)=>a.createdAt - b.createdAt);
    else if (state.draftsSort === 'title') items.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
    draftsListEl.innerHTML = items.map((d, idx)=>{
      const dt = d.createdAt ? new Date(d.createdAt) : null;
      const human = dt ? new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' }).format(dt) : '';
      const iso = dt ? dt.toISOString() : '';
      const title = d.title?.trim() || '(Untitled)';
      return `<div class="draft-item" data-draft-index="${idx}">`
        + `<div class="info"><div class="title">${title}</div><div class="meta" title="${iso}">${human}</div></div>`
        + `<button class="del" title="Delete draft" aria-label="Delete draft">Ã—</button>`
        + `</div>`;
    }).join('');

    // Click to load draft
    draftsListEl.querySelectorAll('.draft-item').forEach(el=>{
      el.addEventListener('click', ()=>{
        const i = parseInt(el.getAttribute('data-draft-index'), 10);
        const d = items[i];
        if (!d) return;
        loadDraft(d);
      });
      const del = el.querySelector('.del');
      del?.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const i = parseInt(el.getAttribute('data-draft-index'), 10);
        const d = items[i];
        if (!d) return;
        const ok = confirm(`Delete draft "${(d.title||'(Untitled)')}"?`);
        if (!ok) return;
        const idxInState = state.drafts.findIndex(x=> x.createdAt === d.createdAt);
        if (idxInState >= 0) state.drafts.splice(idxInState,1);
        renderDrafts();
        saveToCache();
      });
    });
  }

  // ---- Persistence: localStorage ----
  const LS_KEY = 'editorial_port_drafts_v1';
  function saveToCache(){
    try {
      const payload = { drafts: state.drafts, sort: state.draftsSort };
      localStorage.setItem(LS_KEY, JSON.stringify(payload));
    } catch {}
  }
  function loadFromCache(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed?.drafts) state.drafts = parsed.drafts;
        if (parsed?.sort) { state.draftsSort = parsed.sort; draftsSortEl.value = state.draftsSort; }
      }
    } catch {}
  }

  function loadDraft(d){
    // Restore simple fields
  document.getElementById('headline').value = d.title || '';
  document.getElementById('author').value = d.author || '';
  document.getElementById('category').value = d.category || 'Feature';
  document.getElementById('positiontag').value = d.position || '';

    // Restore tags
    state.chips = Array.isArray(d.tags) ? [...d.tags] : [];
    renderChips();
    updateTagInputState();

    // Restore pages & titles
    state.pages = { ...(d.pages || {}) };
    state.pageTitles = { ...(d.pageTitles || {}) };

    // Rebuild tabs
  const existingTabs = Array.from(tablist.querySelectorAll('.tab'));
    existingTabs.forEach(t=> t.remove());
    const addBtn = document.getElementById('addPage');
    const ids = Object.keys(state.pages).sort((a,b)=>{
      const na = parseInt(a.replace('pg',''),10);
      const nb = parseInt(b.replace('pg',''),10);
      return na - nb;
    });
    ids.forEach((id, idx)=>{
      const tab = document.createElement('button');
      tab.className = 'tab';
      tab.type='button';
      tab.setAttribute('role','tab');
      tab.setAttribute('aria-selected','false');
      tab.dataset.tab = id;
      tab.textContent = state.pageTitles[id] || `PG.${idx+1}`;
      tablist.insertBefore(tab, addBtn);
    });

    // Activate first tab
    const firstId = ids[0] || 'pg1';
    switchTo(firstId);
    // Refresh delete button and other dependent states
    updateDeleteButtonState();
  }

  draftsSortEl.addEventListener('change', ()=>{
    state.draftsSort = draftsSortEl.value;
    renderDrafts();
    saveToCache();
  });

  modalDraft.addEventListener('click', ()=>{
    const payload = collectPayload();
    state.drafts.push(payload);
    renderDrafts();
    saveToCache();
    closePublishModal();
  });

  modalPublishNow.addEventListener('click', ()=>{ finishAndMerge(); });

  // removed HTML/Markdown export actions

  // (GitHub integration removed)

  // removed ZIP-based Download Package

  // ================= Admin Tabs & Workspace =================
  let workspaceRoot = null; // DirectoryHandle
  // Persist chosen workspace so it's reused automatically
  const DB_NAME = 'lld-admin-fs';
  const STORE = 'handles';
  function idbOpen(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = ()=>{ try { req.result.createObjectStore(STORE); } catch {} };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }
  function idbPut(key, value){
    return idbOpen().then(db=> new Promise((res, rej)=>{
      const tx = db.transaction(STORE, 'readwrite');
      tx.objectStore(STORE).put(value, key);
      tx.oncomplete = ()=> res();
      tx.onerror = ()=> rej(tx.error);
    }));
  }
  function idbGet(key){
    return idbOpen().then(db=> new Promise((res, rej)=>{
      const tx = db.transaction(STORE, 'readonly');
      const rq = tx.objectStore(STORE).get(key);
      rq.onsuccess = ()=> res(rq.result);
      rq.onerror = ()=> rej(rq.error);
    }));
  }
  async function verifyPermission(handle, mode='readwrite'){
    try {
      if (!handle?.queryPermission || !handle?.requestPermission) return true;
      const q = await handle.queryPermission({ mode });
      if (q === 'granted') return true;
      const r = await handle.requestPermission({ mode });
      return r === 'granted';
    } catch { return false; }
  }
  async function restoreWorkspace(){
    try {
      const h = await idbGet('workspace');
      if (h) {
        const ok = await verifyPermission(h, 'readwrite');
        if (ok) workspaceRoot = h;
      }
    } catch {}
  }
  const adminTabs = document.getElementById('adminTabs');
  const pageTitleEl = document.getElementById('pageTitle');
  const panelEditor = document.getElementById('panel-editor');
  const panelSpot = document.getElementById('panel-spotlights');
  const panelArts = document.getElementById('panel-articles');
  const panelMeta = document.getElementById('panel-sitemeta');
  const chooseWorkspaceBtn = document.getElementById('chooseWorkspaceBtn');

  function setAdminTab(tab){
    document.querySelectorAll('#adminTabs .tab').forEach(b=>{
      b.setAttribute('aria-selected', b.dataset.admin===tab ? 'true' : 'false');
    });
  panelEditor.hidden = tab !== 'editor';
  panelSpot.hidden = tab !== 'spotlights';
  panelArts.hidden = tab !== 'articles';
  panelMeta.hidden = tab !== 'sitemeta';
  pageTitleEl.textContent = tab==='editor' ? 'Edit Article' : (tab==='spotlights' ? 'Edit Spotlights' : (tab==='articles' ? 'Manage Articles' : 'Edit Site Meta'));
  }
  adminTabs.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab');
    if(!btn) return;
    if(btn.getAttribute('aria-selected')==='true') return;
    setAdminTab(btn.dataset.admin);
  });
  chooseWorkspaceBtn.addEventListener('click', async ()=>{
    if (!window.showDirectoryPicker) { alert('Your browser does not support file system access.'); return; }
    try {
      const picked = await window.showDirectoryPicker();
      if (!picked) return;
      const ok = await verifyPermission(picked, 'readwrite');
      if (!ok) { alert('Permission denied for this folder.'); return; }
      workspaceRoot = picked;
      try { await idbPut('workspace', picked); } catch {}
      alert('Workspace selected.');
    }
    catch {}
  });

  // ================= Spotlights Editor =================
  const spotlightsList = document.getElementById('spotlightsList');
  const spotLoadBtn = document.getElementById('spotlightsLoadBtn');
  const spotSaveBtn = document.getElementById('spotlightsSaveBtn');
  const spotAddBtn = document.getElementById('spotlightsAddBtn');
  let spotData = { spotlights: [] };

  function renderSpotlights(){
    const list = Array.isArray(spotData.spotlights) ? spotData.spotlights : [];
    spotlightsList.innerHTML = list.map((s, idx)=>{
      return `<div class="spot-item" data-index="${idx}" style="border:1px solid var(--color-border); border-radius:8px; padding:12px; display:grid; gap:8px; grid-template-columns: 1fr 1fr;">
        <label class="label">Name<input class="input spot-name" value="${s.name||''}"/></label>
        <label class="label">Role<input class="input spot-role" value="${s.role||''}"/></label>
        <label class="label" style="grid-column: span 2;">Blurb<textarea class="input spot-blurb" rows="3">${s.blurb||''}</textarea></label>
        <label class="label">Image URL<input class="input spot-img" value="${s.imageUrl||''}" placeholder="https://..."/></label>
        <label class="label">Image Alt<input class="input spot-alt" value="${s.imageAlt||''}"/></label>
        <label class="label">Link<input class="input spot-link" value="${s.link||''}" placeholder="LLD-Article-Page.html?id=..."/></label>
        <div style="display:flex; align-items:end; gap:8px;">
          <button class="btn spot-up" type="button">â†‘</button>
          <button class="btn spot-down" type="button">â†“</button>
          <button class="btn spot-del" type="button" style="border-color:#dc3545; color:#dc3545;">Delete</button>
        </div>
      </div>`;
    }).join('');
    // Cap at 4
    if (spotAddBtn) spotAddBtn.disabled = list.length >= 4;
    // Wire inputs and buttons
    spotlightsList.querySelectorAll('.spot-item').forEach(item=>{
      const idx = parseInt(item.dataset.index,10);
      const bind = (sel, key) => { item.querySelector(sel).addEventListener('input', e=>{ spotData.spotlights[idx][key] = e.target.value; }); };
      bind('.spot-name','name'); bind('.spot-role','role'); bind('.spot-blurb','blurb'); bind('.spot-img','imageUrl'); bind('.spot-alt','imageAlt'); bind('.spot-link','link');
      item.querySelector('.spot-up').addEventListener('click', ()=>{ if(idx>0){ const t=spotData.spotlights[idx-1]; spotData.spotlights[idx-1]=spotData.spotlights[idx]; spotData.spotlights[idx]=t; renderSpotlights(); }});
      item.querySelector('.spot-down').addEventListener('click', ()=>{ if(idx<spotData.spotlights.length-1){ const t=spotData.spotlights[idx+1]; spotData.spotlights[idx+1]=spotData.spotlights[idx]; spotData.spotlights[idx]=t; renderSpotlights(); }});
      item.querySelector('.spot-del').addEventListener('click', ()=>{ spotData.spotlights.splice(idx,1); renderSpotlights(); });
    });
  }
  spotAddBtn.addEventListener('click', ()=>{
    if ((spotData.spotlights?.length||0) >= 4) { alert('You can only feature up to 4 spotlights.'); return; }
    spotData.spotlights.push({ id: Date.now().toString(), name:'', role:'', blurb:'', imageUrl:'', imageAlt:'', link:'' });
    renderSpotlights();
  });
  spotLoadBtn.addEventListener('click', async ()=>{
    try {
      if(!workspaceRoot) { alert('Choose a workspace first.'); return; }
      const data = await readJsonIfExists(workspaceRoot, 'Spotlights.json');
      spotData = data || { spotlights: [] };
      if ((spotData.spotlights?.length||0) > 4) {
        spotData.spotlights = spotData.spotlights.slice(0,4);
        alert('Spotlights capped at 4. Extra entries were ignored.');
      }
      renderSpotlights();
    } catch { alert('Failed to load Spotlights.json'); }
  });
  spotSaveBtn.addEventListener('click', async ()=>{
    try {
      if(!workspaceRoot) { alert('Choose a workspace first.'); return; }
      if ((spotData.spotlights?.length||0) > 4) spotData.spotlights = spotData.spotlights.slice(0,4);
      await writeFile(workspaceRoot, 'Spotlights.json', JSON.stringify(spotData, null, 2));
      alert('Spotlights saved.');
    } catch { alert('Failed to save Spotlights.json'); }
  });

  // ================= Articles Manager =================
  const publishedList = document.getElementById('publishedList');
  const draftsPublishList = document.getElementById('draftsPublishList');
  const catalogLoadBtn = document.getElementById('catalogLoadBtn');
  const catalogSaveBtn = document.getElementById('catalogSaveBtn');
  const publishCurrentBtn = document.getElementById('publishCurrentBtn');
  let catalogState = { articles: [], version:'1.0' };

  function renderPublished(){
    const arts = Array.isArray(catalogState.articles) ? catalogState.articles.slice().sort((a,b)=> new Date(b.time_posted) - new Date(a.time_posted)) : [];
    publishedList.innerHTML = arts.map(a=>{
      const dt = a.time_posted ? new Date(a.time_posted) : null;
      const human = dt ? new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' }).format(dt) : '';
      const iso = dt ? dt.toISOString() : '';
      return `<div style="display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center; border:1px solid var(--color-border); border-radius:8px; padding:8px;">
        <div><div style=\"font-weight:600;\">${a.title||'(Untitled)'} <span style=\"color:#6c757d; font-weight:400;\">â€” ${a.category||''}</span></div>
        <div class=\"smallcaps\" title=\"${iso}\">${human}</div></div>
        <button class=\"btn\" data-open=\"${a.id}\">Open</button>
        <button class=\"btn\" style=\"border-color:#dc3545; color:#dc3545;\" data-remove=\"${a.id}\">Remove</button>
      </div>`;
    }).join('');
    // wire buttons
    publishedList.querySelectorAll('button[data-open]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-open');
        if(!workspaceRoot) { alert('Choose a workspace first.'); return; }
        try {
          const art = await readJsonIfExists(workspaceRoot, `articles/${id}.json`);
          if (!art) { alert('Article body not found'); return; }
          // Load into editor
          document.getElementById('headline').value = art.title || '';
          document.getElementById('author').value = art.author || '';
          document.getElementById('category').value = art.category || 'Feature';
          state.chips = Array.isArray(art.tags)?[...art.tags]:[]; renderChips(); updateTagInputState();
          // pages
          const pages = {}; const titles={};
          (art.pages||[]).forEach((p, idx)=>{ const idd = `pg${idx+1}`; pages[idd]=p.html||''; titles[idd]=p.title||`PG.${idx+1}`; });
          state.pages = pages; state.pageTitles = titles;
          // Rebuild tabs
          const existingTabs = Array.from(tablist.querySelectorAll('.tab'));
          existingTabs.forEach(t=> t.remove());
          const addBtn = document.getElementById('addPage');
          Object.keys(pages).forEach((id, i)=>{ const tab=document.createElement('button'); tab.className='tab'; tab.type='button'; tab.setAttribute('role','tab'); tab.setAttribute('aria-selected', i===0?'true':'false'); tab.dataset.tab=id; tab.textContent=titles[id]; tablist.insertBefore(tab, addBtn); });
          switchTo('pg1'); updateDeleteButtonState(); setAdminTab('editor');
        } catch { alert('Failed to open article'); }
      });
    });
    publishedList.querySelectorAll('button[data-remove]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.getAttribute('data-remove');
        const idx = catalogState.articles.findIndex(a=>String(a.id)===String(id));
        if (idx>=0) { const ok = confirm('Remove from catalog? This will not delete the article file.'); if(ok){ catalogState.articles.splice(idx,1); renderPublished(); } }
      });
    });
    // Drafts with quick publish
  const items = [...state.drafts];
  draftsPublishList.innerHTML = items.map((d, idx)=>{
      const dt = d.createdAt ? new Date(d.createdAt) : null;
      const human = dt ? new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' }).format(dt) : '';
      const iso = dt ? dt.toISOString() : '';
      return `<div style="display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; border:1px dashed var(--color-border); border-radius:8px; padding:8px;">`
        + `<div><div style=\"font-weight:600;\">${d.title||'(Untitled)'}</div><div class=\"smallcaps\" title=\"${iso}\">${human}</div></div>`
        + `<button class=\"btn\" data-publish-draft=\"${idx}\">Publish</button>`
      + `</div>`;
    }).join('');
    draftsPublishList.querySelectorAll('button[data-publish-draft]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const idx = parseInt(b.getAttribute('data-publish-draft'),10);
        const draft = items[idx]; if(!draft){ return; }
        if(!workspaceRoot) { alert('Choose a workspace first.'); return; }
        await publishPayloadToWorkspace(draft);
        await loadCatalogFromWorkspace();
        renderPublished();
      });
    });
  }

  async function loadCatalogFromWorkspace(){
    if(!workspaceRoot) { alert('Choose a workspace first.'); return; }
    const data = await readJsonIfExists(workspaceRoot, 'ArticleCatalog.json');
    catalogState = data || { articles: [], version:'1.0' };
  }
  if (catalogLoadBtn) catalogLoadBtn.addEventListener('click', async ()=>{ await loadCatalogFromWorkspace(); renderPublished(); });
  catalogSaveBtn?.addEventListener('click', async ()=>{
    if(!workspaceRoot) { alert('Choose a workspace first.'); return; }
    catalogState.last_updated = new Date().toISOString();
    await writeFile(workspaceRoot, 'ArticleCatalog.json', JSON.stringify(catalogState, null, 2));
    alert('Catalog saved.');
  });

  // ================= Site Meta Editor =================
  const smLoadBtn = document.getElementById('siteMetaLoadBtn');
  const smSaveBtn = document.getElementById('siteMetaSaveBtn');
  const smDate = document.getElementById('smDate');
  const smLocation = document.getElementById('smLocation');
  const smUnit = document.getElementById('smUnit');
  const smNowTemp = document.getElementById('smNowTemp');
  const smNowCond = document.getElementById('smNowCond');
  const smHigh = document.getElementById('smHigh');
  const smLow = document.getElementById('smLow');
  const smSummary = document.getElementById('smSummary');
  const smEventsWrap = document.getElementById('siteMetaEvents');
  const smScoresWrap = document.getElementById('siteMetaScores');
  const addEventBtn2 = document.getElementById('addEventBtn');
  const addScoreBtn2 = document.getElementById('addScoreBtn');
  const evSortBtn = document.getElementById('evSortBtn');
  const evClearPastBtn = document.getElementById('evClearPastBtn');
  const smPreviewPill = document.getElementById('smPreviewPill');
  const smPreviewWeather = document.getElementById('smPreviewWeather');
  let siteMeta = { meta: { date:'', location:'', unit:'F', now: { temp:null, condition:'' } }, weather:{ high:null, low:null, summary:'' }, events:[], scores:[] };

  function formatLongDate(iso){
    try { const d = new Date(iso); return d.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'}); } catch(e){ return ''; }
  }

  function updatePreview(){
    const dateStr = formatLongDate(siteMeta?.meta?.date || '');
    const temp = siteMeta?.meta?.now?.temp;
    const unit = siteMeta?.meta?.unit || 'F';
    const loc  = siteMeta?.meta?.location || '';
    const parts = [];
    if (dateStr) parts.push(dateStr);
    if (temp !== null && temp !== undefined && temp !== '') parts.push(`${temp}Â°${unit}`);
    if (loc) parts.push(loc);
    if (smPreviewPill) smPreviewPill.textContent = parts.join(' â€¢ ') || 'â€”';
    const w = siteMeta?.weather || {};
    const wText = (w.high!=null && w.low!=null && w.summary)
      ? `High ${w.high}Â° / Low ${w.low}Â° â€¢ ${w.summary}`
      : (temp!=null ? `${temp}Â°${unit}${siteMeta?.meta?.now?.condition?(' â€¢ '+siteMeta.meta.now.condition):''}` : '');
    if (smPreviewWeather) smPreviewWeather.textContent = wText || 'â€”';
  }

  function renderSiteMeta(){
    // top-level meta fields
    smDate.value = (siteMeta.meta?.date || '').slice(0,10);
    smLocation.value = siteMeta.meta?.location || '';
    smUnit.value = siteMeta.meta?.unit || 'F';
    smNowTemp.value = siteMeta.meta?.now?.temp ?? '';
    smNowCond.value = siteMeta.meta?.now?.condition || '';
    smHigh.value = siteMeta.weather?.high ?? '';
    smLow.value = siteMeta.weather?.low ?? '';
    smSummary.value = siteMeta.weather?.summary || '';

    // events list
    const evs = Array.isArray(siteMeta.events) ? siteMeta.events : [];
    smEventsWrap.innerHTML = evs.map((ev, idx)=>{
      return `<div class="ev-item" data-index="${idx}" style="display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:end; border:1px solid var(--color-border); border-radius:8px; padding:8px;">
        <label class="label" style="margin:0;">Title<input class="input ev-title" value="${ev.title||''}" /></label>
        <div style="display:flex; gap:6px; align-items:center; justify-content:flex-end;">
          <button class="btn ev-up" type="button">â†‘</button>
          <button class="btn ev-down" type="button">â†“</button>
          <button class="btn ev-del" type="button" style="border-color:#dc3545; color:#dc3545;">Delete</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; grid-column: 1 / -1;">
          <label class="label" style="margin:0;">Date
            <input class="input ev-date" type="date" value="${(ev.date||'').slice(0,10)}" />
          </label>
          <label class="label" style="margin:0;">Time
            <input class="input ev-time" type="time" value="${(ev.time||'')}" />
          </label>
        </div>
      </div>`;
    }).join('');

    smEventsWrap.querySelectorAll('.ev-item').forEach(item=>{
      const idx = parseInt(item.dataset.index,10);
      item.querySelector('.ev-title').addEventListener('input', e=>{ siteMeta.events[idx].title = e.target.value; });
      item.querySelector('.ev-date').addEventListener('change', e=>{ siteMeta.events[idx].date = e.target.value; });
      const timeEl = item.querySelector('.ev-time');
      timeEl.addEventListener('change', e=>{ siteMeta.events[idx].time = e.target.value; });
      item.querySelector('.ev-up').addEventListener('click', ()=>{ if(idx>0){ const t=siteMeta.events[idx-1]; siteMeta.events[idx-1]=siteMeta.events[idx]; siteMeta.events[idx]=t; renderSiteMeta(); }});
      item.querySelector('.ev-down').addEventListener('click', ()=>{ if(idx<siteMeta.events.length-1){ const t=siteMeta.events[idx+1]; siteMeta.events[idx+1]=siteMeta.events[idx]; siteMeta.events[idx]=t; renderSiteMeta(); }});
      item.querySelector('.ev-del').addEventListener('click', ()=>{ siteMeta.events.splice(idx,1); renderSiteMeta(); });
    });

    // scores list
    const scs = Array.isArray(siteMeta.scores) ? siteMeta.scores : [];
    smScoresWrap.innerHTML = scs.map((sc, idx)=>{
      return `<div class="sc-item" data-index="${idx}" style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:8px; align-items:end; border:1px solid var(--color-border); border-radius:8px; padding:8px;">
        <label class="label" style="margin:0;">Sport<input class="input sc-sport" value="${sc.sport||''}" /></label>
        <label class="label" style="margin:0;">Opponent<input class="input sc-opp" value="${sc.opponent||''}" /></label>
        <label class="label" style="margin:0;">Result<input class="input sc-res" value="${sc.result||''}" /></label>
        <div style="display:flex; gap:6px; align-items:center; justify-content:flex-end;">
          <button class="btn sc-up" type="button">â†‘</button>
          <button class="btn sc-down" type="button">â†“</button>
          <button class="btn sc-del" type="button" style="border-color:#dc3545; color:#dc3545;">Delete</button>
        </div>
      </div>`;
    }).join('');

    smScoresWrap.querySelectorAll('.sc-item').forEach(item=>{
      const idx = parseInt(item.dataset.index,10);
      item.querySelector('.sc-sport').addEventListener('input', e=>{ siteMeta.scores[idx].sport = e.target.value; });
      item.querySelector('.sc-opp').addEventListener('input', e=>{ siteMeta.scores[idx].opponent = e.target.value; });
      item.querySelector('.sc-res').addEventListener('input', e=>{ siteMeta.scores[idx].result = e.target.value; });
      item.querySelector('.sc-up').addEventListener('click', ()=>{ if(idx>0){ const t=siteMeta.scores[idx-1]; siteMeta.scores[idx-1]=siteMeta.scores[idx]; siteMeta.scores[idx]=t; renderSiteMeta(); }});
      item.querySelector('.sc-down').addEventListener('click', ()=>{ if(idx<siteMeta.scores.length-1){ const t=siteMeta.scores[idx+1]; siteMeta.scores[idx+1]=siteMeta.scores[idx]; siteMeta.scores[idx]=t; renderSiteMeta(); }});
      item.querySelector('.sc-del').addEventListener('click', ()=>{ siteMeta.scores.splice(idx,1); renderSiteMeta(); });
    });

    updatePreview();
  }

  function readFormToState(){
    siteMeta.meta = siteMeta.meta || {};
    siteMeta.meta.date = smDate.value || '';
    siteMeta.meta.location = smLocation.value || '';
    siteMeta.meta.unit = smUnit.value || 'F';
    siteMeta.meta.now = siteMeta.meta.now || {};
    siteMeta.meta.now.temp = smNowTemp.value !== '' ? Number(smNowTemp.value) : null;
    siteMeta.meta.now.condition = smNowCond.value || '';
    siteMeta.weather = siteMeta.weather || {};
    siteMeta.weather.high = smHigh.value !== '' ? Number(smHigh.value) : null;
    siteMeta.weather.low = smLow.value !== '' ? Number(smLow.value) : null;
    siteMeta.weather.summary = smSummary.value || '';
    updatePreview();
  }

  addEventBtn2.addEventListener('click', ()=>{
    siteMeta.events = Array.isArray(siteMeta.events) ? siteMeta.events : [];
    siteMeta.events.push({ title:'', date:'' });
    renderSiteMeta();
  });
  addScoreBtn2.addEventListener('click', ()=>{
    siteMeta.scores = Array.isArray(siteMeta.scores) ? siteMeta.scores : [];
    siteMeta.scores.push({ sport:'', opponent:'', result:'' });
    renderSiteMeta();
  });

  smLoadBtn.addEventListener('click', async ()=>{
    try {
      if(!workspaceRoot) { alert('Choose a workspace first.'); return; }
      const data = await readJsonIfExists(workspaceRoot, 'SiteMeta.json');
      siteMeta = data || { meta:{}, weather:{}, events:[], scores:[] };
      renderSiteMeta();
    } catch { alert('Failed to load SiteMeta.json'); }
  });

  smSaveBtn.addEventListener('click', async ()=>{
    try {
      if(!workspaceRoot) { alert('Choose a workspace first.'); return; }
      readFormToState();
      // Basic cleanup: drop nulls where appropriate
      const out = JSON.stringify(siteMeta, null, 2);
      await writeFile(workspaceRoot, 'SiteMeta.json', out);
      alert('Site meta saved.');
    } catch { alert('Failed to save SiteMeta.json'); }
  });
  if (publishCurrentBtn) publishCurrentBtn.addEventListener('click', ()=>{ openPublishModal(); });

  // Live preview wiring for inputs
  [smDate, smLocation, smUnit, smNowTemp, smNowCond, smHigh, smLow, smSummary].forEach(el=>{
    if (!el) return;
    el.addEventListener('input', ()=>{ readFormToState(); updatePreview(); });
    el.addEventListener('change', ()=>{ readFormToState(); updatePreview(); });
  });

  // Event utilities
  evSortBtn?.addEventListener('click', ()=>{
    siteMeta.events = (siteMeta.events||[]).slice().sort((a,b)=>{
      const da = new Date((a.date||'') + (a.time?('T'+a.time):''));
      const db = new Date((b.date||'') + (b.time?('T'+b.time):''));
      return da - db;
    });
    renderSiteMeta();
  });
  evClearPastBtn?.addEventListener('click', ()=>{
    const now = new Date();
    siteMeta.events = (siteMeta.events||[]).filter(ev=>{
      const d = new Date((ev.date||'') + (ev.time?('T'+ev.time):''));
      return isFinite(d) ? d >= now : true;
    });
    renderSiteMeta();
  });

  async function publishPayloadToWorkspace(payload){
    // Similar to finishAndMerge but accepts payload
    const nowIso = new Date().toISOString();
    const baseSlug = toSafeSlug(payload.title||'Untitled') || 'untitled';
    const id = `${nowIso.slice(0,10).replace(/-/g,'')}-${baseSlug}`;
    // Ensure we have a workspace; restore or prompt once
    if (!workspaceRoot) { try { await restoreWorkspace(); } catch {} }
    if (!workspaceRoot) {
      if (!window.showDirectoryPicker) { alert('Your browser does not support writing files.'); return; }
      const picked = await window.showDirectoryPicker();
      if (!picked) return;
      const ok = await verifyPermission(picked, 'readwrite');
      if (!ok) { alert('Permission denied for this folder.'); return; }
      workspaceRoot = picked; try { await idbPut('workspace', picked); } catch {}
    } else {
      const ok = await verifyPermission(workspaceRoot, 'readwrite');
      if (!ok) { alert('No permission to write to the chosen workspace. Please choose again.'); return; }
    }
    // Merge catalog
    const catalog = (await readJsonIfExists(workspaceRoot, 'ArticleCatalog.json')) || { articles: [], version:'1.0' };
    const entry = {
      id,
      title: payload.title || 'Untitled',
      tags: Array.isArray(payload.tags)?payload.tags:[],
      category: payload.category || (payload.tags && payload.tags[0]) || 'NEWS',
      time_posted: nowIso,
      homepage_position: payload.position || '',
      imageUrl: '',
      imageAlt: ''
    };
    const idx = (catalog.articles||[]).findIndex(a=>String(a.id)===String(id));
    if (idx>=0) catalog.articles[idx] = { ...(catalog.articles[idx]||{}), ...entry };
    else (catalog.articles||[]).push(entry);
    catalog.last_updated = nowIso;
    catalog.version = bumpVersion(catalog.version);

    // Build pages
    const pageIds = Object.keys(payload.pages||{}).sort((a,b)=>parseInt(a.replace('pg',''))-parseInt(b.replace('pg','')));
    const pages = pageIds.map((pid, i)=>{
      const html = String(payload.pages[pid]||'');
      const markdown = htmlToMarkdownFromEditor(html);
      const title = payload.pageTitles?.[pid] || (i?`Page ${i+1}`:'');
      return { title, markdown, html };
    });
    const articleObj = { id, title: payload.title||'Untitled', category: entry.category, tags: entry.tags, pages };
    await writeFile(workspaceRoot, 'ArticleCatalog.json', JSON.stringify(catalog, null, 2));
    await writeFile(workspaceRoot, `articles/${id}.json`, JSON.stringify(articleObj, null, 2));
    alert('Draft published.');
  }

  // ================= GitHub Auto Commit Integration =================
  ;(()=>{
    const cfgKey = 'lld_github_cfg_v1';
    const els = {
      btn: document.getElementById('githubConfigBtn'),
      modal: document.getElementById('ghModal'),
      owner: document.getElementById('ghOwner'),
      repo: document.getElementById('ghRepo'),
      branch: document.getElementById('ghBranch'),
      base: document.getElementById('ghBasePath'),
      token: document.getElementById('ghToken'),
      remember: document.getElementById('ghRemember'),
      auto: document.getElementById('ghAuto'),
      save: document.getElementById('ghSave'),
      close: document.getElementById('ghClose'),
      status: document.getElementById('ghStatus')
    };
    let cfg = { owner:'', repo:'', branch:'main', base:'', token:'', remember:false, auto:false };
    function loadCfg(){
      try {
        const raw = localStorage.getItem(cfgKey);
        if (raw) { const o = JSON.parse(raw); cfg = { ...cfg, ...o }; }
      } catch {}
      els.owner.value = cfg.owner||'';
      els.repo.value = cfg.repo||'';
      els.branch.value = cfg.branch||'main';
      els.base.value = cfg.base||'';
      els.auto.checked = !!cfg.auto;
      els.remember.checked = !!cfg.remember;
      if (cfg.remember && cfg.token) els.token.value = cfg.token; else els.token.value='';
    }
    function persistCfg(){
      const out = { ...cfg };
      if (!out.remember) delete out.token;
      try { localStorage.setItem(cfgKey, JSON.stringify(out)); } catch {}
    }
    function openModal(){ loadCfg(); els.modal.style.display='flex'; }
    function closeModal(){ els.modal.style.display='none'; }
    els.btn?.addEventListener('click', openModal);
    els.close?.addEventListener('click', closeModal);
    els.modal?.addEventListener('click', e=>{ if(e.target===els.modal) closeModal(); });
    els.save?.addEventListener('click', ()=>{
      cfg.owner = els.owner.value.trim();
      cfg.repo = els.repo.value.trim();
      cfg.branch = els.branch.value.trim()||'main';
      cfg.base = els.base.value.trim().replace(/(^\/|\/$)/g,'');
      const tok = els.token.value.trim();
      cfg.remember = els.remember.checked;
      cfg.auto = els.auto.checked;
      if (tok) cfg.token = tok; else if(!cfg.remember) cfg.token='';
      persistCfg();
      flashStatus('Saved.');
      if(!cfg.token) flashStatus('Warning: No token set. Auto commit will be skipped.', true);
    });
    function flashStatus(msg, warn=false){ if(!els.status) return; els.status.textContent = msg; els.status.style.color = warn? '#c00':'#198754'; setTimeout(()=>{ if(els.status.textContent===msg) els.status.textContent=''; }, 5000); }
    function ghHeaders(){ return { 'Accept':'application/vnd.github+json', 'Authorization': 'Bearer ' + cfg.token, 'X-GitHub-Api-Version':'2022-11-28' }; }
    async function gh(path, opts={}){
      const r = await fetch(`https://api.github.com${path}`, { ...opts, headers:{ ...(opts.headers||{}), ...ghHeaders() } });
      if(!r.ok){ const t = await r.text(); throw new Error(`GitHub ${r.status}: ${t.slice(0,200)}`); }
      return r.json();
    }
    async function getRef(){ return gh(`/repos/${cfg.owner}/${cfg.repo}/git/refs/heads/${cfg.branch}`); }
    async function createBlob(content){ return gh(`/repos/${cfg.owner}/${cfg.repo}/git/blobs`, { method:'POST', body: JSON.stringify({ content: btoa(unescape(encodeURIComponent(content))), encoding:'base64' }) }); }
    async function createTree(baseTreeSha, files){
      const tree = files.map(f=>({ path: (cfg.base? (cfg.base + '/' + f.path): f.path).replace(/\\/g,'/'), mode:'100644', type:'blob', sha: f.sha }));
      return gh(`/repos/${cfg.owner}/${cfg.repo}/git/trees`, { method:'POST', body: JSON.stringify({ base_tree: baseTreeSha, tree }) });
    }
    async function createCommit(message, treeSha, parentSha){ return gh(`/repos/${cfg.owner}/${cfg.repo}/git/commits`, { method:'POST', body: JSON.stringify({ message, tree: treeSha, parents:[parentSha] }) }); }
    async function updateRef(sha){ return gh(`/repos/${cfg.owner}/${cfg.repo}/git/refs/heads/${cfg.branch}`, { method:'PATCH', body: JSON.stringify({ sha, force:false }) }); }
    async function ensureCfgReady(){ return cfg.owner && cfg.repo && cfg.branch && cfg.token; }

    async function githubAutoCommit(changedFiles, contextMsg){
      try {
        if(!cfg.auto) return; // silent skip
        if(!await ensureCfgReady()) return;
        if(!changedFiles || !changedFiles.length) return;
        flashStatus('Committing '+changedFiles.length+' file(s)...');
        const ref = await getRef();
        const baseSha = ref.object.sha;
        // Need current commit to get tree
        const commitObj = await gh(`/repos/${cfg.owner}/${cfg.repo}/git/commits/${baseSha}`);
        const baseTreeSha = commitObj.tree.sha;
        // Create blobs
        const blobs = [];
        for (const f of changedFiles){
          const blob = await createBlob(f.content);
            blobs.push({ path:f.path, sha: blob.sha });
        }
        const newTree = await createTree(baseTreeSha, blobs);
        const message = contextMsg + ' ('+ new Date().toISOString()+')';
        const newCommit = await createCommit(message, newTree.sha, baseSha);
        await updateRef(newCommit.sha);
        flashStatus('Committed '+changedFiles.length+' file(s).');
      } catch(err){
        flashStatus('GitHub error: '+ err.message.slice(0,160), true);
      }
    }

    // Hook into existing flows
    // 1. finishAndMerge
    const _finishAndMerge = window.finishAndMerge;
    window.finishAndMerge = async function(){
      const before = Date.now();
      await _finishAndMerge.apply(this, arguments);
      try {
        // Derive new article id from last alert by reconstructing? Instead easier: re-run minimal logic to sniff current editor state
        const payload = collectPayload();
        const nowIso = new Date().toISOString();
        const baseSlug = (payload.title? toSafeSlug(payload.title):'untitled') || 'untitled';
        const id = `${nowIso.slice(0,10).replace(/-/g,'')}-${baseSlug}`; // matches original logic (race risk acceptable)
        const files = [
          { path:'ArticleCatalog.json', content: JSON.stringify((await readJsonIfExists(workspaceRoot,'ArticleCatalog.json'))||{}, null,2) },
          { path:`articles/${id}.json`, content: JSON.stringify({ placeholder:true}, null,2) }
        ];
        // Replace placeholder with actual file if accessible (best-effort)
        try {
          const art = await readJsonIfExists(workspaceRoot, `articles/${id}.json`);
          if (art) files[1].content = JSON.stringify(art, null, 2);
        } catch {}
        githubAutoCommit(files, 'chore: finish & merge article');
      } catch(e){ flashStatus('Post-merge commit prep failed', true); }
    };

    // 2. publishPayloadToWorkspace
    const _publishPayloadToWorkspace = window.publishPayloadToWorkspace;
    window.publishPayloadToWorkspace = async function(payload){
      await _publishPayloadToWorkspace.apply(this, arguments);
      try {
        const nowIso = new Date().toISOString();
        const baseSlug = (payload.title? toSafeSlug(payload.title):'untitled') || 'untitled';
        const id = `${nowIso.slice(0,10).replace(/-/g,'')}-${baseSlug}`;
        const files = [
          { path:'ArticleCatalog.json', content: JSON.stringify((await readJsonIfExists(workspaceRoot,'ArticleCatalog.json'))||{}, null,2) },
          { path:`articles/${id}.json`, content: JSON.stringify((await readJsonIfExists(workspaceRoot,`articles/${id}.json`))||{}, null,2) }
        ];
        githubAutoCommit(files, 'chore: quick publish draft');
      } catch(e){}
    };

    // 3. Spotlights save
    const spotSaveBtn = document.getElementById('spotlightsSaveBtn');
    spotSaveBtn?.addEventListener('click', ()=>{
      setTimeout(async ()=>{
        try {
          const data = await readJsonIfExists(workspaceRoot, 'Spotlights.json');
          if (data) githubAutoCommit([{ path:'Spotlights.json', content: JSON.stringify(data,null,2)}], 'chore: update spotlights');
        } catch{}
      }, 400);
    });

    // 4. Catalog save
    const catalogSaveBtn2 = document.getElementById('catalogSaveBtn');
    catalogSaveBtn2?.addEventListener('click', ()=>{
      setTimeout(async ()=>{
        try {
          const data = await readJsonIfExists(workspaceRoot, 'ArticleCatalog.json');
          if (data) githubAutoCommit([{ path:'ArticleCatalog.json', content: JSON.stringify(data,null,2)}], 'chore: update catalog');
        } catch{}
      }, 400);
    });

    // 5. Site meta save
    const smSaveBtn2 = document.getElementById('siteMetaSaveBtn');
    smSaveBtn2?.addEventListener('click', ()=>{
      setTimeout(async ()=>{
        try {
          const data = await readJsonIfExists(workspaceRoot, 'SiteMeta.json');
          if (data) githubAutoCommit([{ path:'SiteMeta.json', content: JSON.stringify(data,null,2)}], 'chore: update site meta');
        } catch{}
      }, 400);
    });

    // Initial load silently
    loadCfg();
  })();

  // Restore workspace, then initial load from cache and render
  restoreWorkspace().finally(()=>{
    loadFromCache();
    renderDrafts();
  });
  </script>
</body>
</html>
