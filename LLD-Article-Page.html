<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Leopard Low Down — Article</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { colors: { brand: '#C1121F' } } } };</script>
    <style>
      :root { --brand:#C1121F }
      .smallcaps { font-variant: all-small-caps; letter-spacing:.06em; }
      .font-helvetica { font-family:"Helvetica Neue", Helvetica, Arial, "Liberation Sans", sans-serif; }
  .toast-stack { position: fixed; bottom: 1rem; right: 1rem; display:flex; flex-direction:column; gap:.5rem; z-index:50; }
  .toast { background:#111; color:#fff; padding:.5rem .75rem; font-size:.75rem; border-radius:4px; box-shadow:0 2px 6px rgba(0,0,0,.25); opacity:0; transform:translateY(4px); animation:toast-in .25s forwards; }
  @keyframes toast-in { to { opacity:1; transform:translateY(0);} }
  .toast.fade-out { animation:toast-out .3s forwards; }
  @keyframes toast-out { to { opacity:0; transform:translateY(4px);} }
  /* Elements hidden only when printing (moved into @media print below for proper behavior) */
  /* (We intentionally do NOT hide .print-hidden here so navigation shows on screen.) */
  .tag-pill { display:inline-block; border:1px solid var(--brand); color:var(--brand); font-variant:all-small-caps; letter-spacing:.06em; font-size:11px; padding:2px 7px; line-height:1; border-radius:2px; background:rgba(193,18,31,0.06); font-weight:600; }
  /* Increase whitespace between images and following text */
  #article-body.prose img, #article-body.prose figure { margin-bottom: 1.25rem; }
  /* Inline (non-sticky) pager now sits beside action buttons */
  #page-nav-top { 
    position: static; 
    top: auto; 
    z-index: 1; 
    border: none; 
    backdrop-filter: none; 
    background: transparent; 
    -webkit-backdrop-filter: none;
    margin: 0; 
    padding: 0; 
  }
  /* Tighter alignment & spacing tweaks */
  #article-actions { row-gap:.5rem; }
  #article-actions nav#page-nav-top { display:flex !important; flex-direction:column; align-items:flex-end; gap:4px; min-width:auto !important; }
  #article-actions nav#page-nav-top .compact-pager { gap:4px; }
  #article-actions nav#page-nav-top .pager-numbers button.page-num-btn { min-width:30px; height:30px; font-size:11px; }
  #article-actions nav#page-nav-top .nav-edge { height:30px; padding:0 8px; font-size:11px; }
  #article-actions nav#page-nav-top .pager-progress-bar { margin:2px 0 0 0; width:100%; max-width:none; }
  #compact-pager { position:relative; }
  @media (max-width:640px){
    #article-actions { flex-direction:column; align-items:flex-start; }
    #article-actions nav#page-nav-top { align-items:flex-start; }
    #article-actions nav#page-nav-top .pager-progress-bar { max-width:200px; }
  }
  #page-nav-bottom { display:none !important; }
  .compact-pager { display:flex; align-items:center; gap:.5rem; justify-content:center; max-width:100%; }
  .compact-pager button.nav-edge { 
    height:32px; padding:0 10px; border:1px solid #d1d5db; background:#fff; color:#374151; font-size:12px; font-weight:600; border-radius:6px; display:inline-flex; align-items:center; gap:4px; cursor:pointer; transition:.18s; }
  .compact-pager button.nav-edge:hover:not(:disabled){ border-color:var(--brand); color:var(--brand); }
  .compact-pager button.nav-edge:disabled { opacity:.45; cursor:not-allowed; }
  .pager-numbers { display:flex; align-items:center; gap:4px; flex-wrap:nowrap; overflow-x:auto; scrollbar-width:none; -ms-overflow-style:none; }
  .pager-numbers::-webkit-scrollbar { display:none; }
  .pager-numbers button.page-num-btn { 
     min-width:32px; height:32px; border:1px solid #d1d5db; border-radius:50%; background:#fff; font-size:12px; font-weight:600; color:#374151; cursor:pointer; transition:.18s; display:inline-flex; align-items:center; justify-content:center; }
  .pager-numbers button.page-num-btn:hover { border-color:var(--brand); color:var(--brand); }
  .pager-numbers button.page-num-btn.active { background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 0 0 2px rgba(193,18,31,.25); }
  .pager-numbers span.ellipsis { color:#9ca3af; font-size:12px; padding:0 2px; user-select:none; }
  .pager-progress-bar { position:relative; height:3px; background:#e5e5e5; border-radius:2px; margin:.4rem auto 0; width:100%; overflow:hidden; }
  .pager-progress-fill { position:absolute; inset:0; width:0%; background:var(--brand); transition:width .3s ease; }
  @media (max-width:640px){
    #page-nav-top { padding:.4rem .25rem .3rem; }
    .compact-pager button.nav-edge { height:30px; padding:0 8px; }
    .pager-numbers button.page-num-btn { min-width:30px; height:30px; font-size:11px; }
  }
  
  /* Navigation buttons */
  .nav-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 6px;
    border: 2px solid;
    transition: all 0.2s ease;
    cursor: pointer;
    text-decoration: none;
  }
  
  .nav-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  .nav-btn-primary {
    background: var(--brand);
    border-color: var(--brand);
    color: white;
  }
  
  .nav-btn-primary:hover:not(:disabled) {
    background: #a00f1a;
    border-color: #a00f1a;
  }
  
  .nav-btn-secondary {
    background: white;
    border-color: #d1d5db;
    color: #374151;
  }
  
  .nav-btn-secondary:hover:not(:disabled) {
    border-color: var(--brand);
    color: var(--brand);
  }
  
  .nav-btn:disabled {
    background: #f3f4f6;
    border-color: #e5e7eb;
    color: #9ca3af;
  }
  
  /* Page indicators */
  .page-indicators {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: center;
    margin: 16px 0;
  }
  
  .page-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #d1d5db;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .page-dot:hover {
    border-color: var(--brand);
    transform: scale(1.1);
  }
  
  .page-dot.active {
    background: var(--brand);
    border-color: var(--brand);
    transform: scale(1.2);
  }
  
  .page-dot::after {
    content: attr(data-page);
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: #6b7280;
    font-weight: 500;
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  
  .page-dot:hover::after {
    opacity: 1;
  }
  
  /* Progress indicator */
  .page-progress-enhanced {
    margin-bottom: 20px;
  }
  
  .page-progress-enhanced .progress-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
    color: #6b7280;
    font-weight: 500;
  }
  
  .page-progress-enhanced .progress-bar-container {
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
  }
  
  .page-progress-enhanced .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--brand) 0%, #e85d75 100%);
    border-radius: 3px;
    transition: width 0.3s ease;
  }
  
  .page-title-display {
    text-align: center;
    margin-bottom: 20px;
    padding: 12px 20px;
    background: white;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
  }
  
  .page-title-display h3 {
    margin: 0;
    color: var(--brand);
    font-size: 18px;
    font-weight: 700;
  }
  
  .page-subtitle {
    margin: 4px 0 0 0;
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
  }
  
  /* Ensure navigation is visible */
  .page-nav-visible {
    display: block !important;
  }
  
  /* Page transition animation */
  #article-body {
    transition: opacity 0.3s ease-in-out;
  }
  .page-transitioning {
    opacity: 0.4;
  }
  
  /* Remove debug styles */
  .debug-nav {
    display: none;
  }
  /* Numbered pager buttons */
  .pager-buttons { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin:14px 0 4px; }
  .pager-buttons button.page-num-btn { 
    min-width:36px; height:36px; padding:0 10px; border:1px solid #d1d5db; border-radius:6px; background:#fff; 
    font-size:14px; font-weight:600; color:#374151; line-height:1; cursor:pointer; transition:.18s; position:relative;
  }
  .pager-buttons button.page-num-btn:hover { border-color: var(--brand); color: var(--brand); box-shadow:0 1px 3px rgba(0,0,0,.08); }
  .pager-buttons button.page-num-btn.active { background: var(--brand); border-color: var(--brand); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.18); }
  .pager-buttons button.page-num-btn:focus-visible { outline:2px solid var(--brand); outline-offset:2px; }
  .pager-buttons button.page-num-btn[disabled] { opacity:.55; cursor:not-allowed; }
  @media print {
    .print-hidden { display:none !important; }
    body { background:#fff !important; color:#000; }
    .toast-stack, #article-actions, a[href="index.html"], .toast { display:none !important; }
    /* Tags: plain in print */
    #article-tags .tag-pill { border-color:#000; color:#000; background:transparent; }
    #article-title { font-size:28pt !important; line-height:1.15; margin-top:0; }
    #article-author { font-size:11pt !important; }
    #article-meta { font-size:10pt !important; color:#555 !important; }
    #article-hero { page-break-inside: avoid; }
    #article-body { font-size:11pt; line-height:1.4; }
    img { max-width:100%; height:auto; }
    @page { margin: 20mm 16mm 22mm; }
    /* Remove link underlines but append URLs for off-page context */
    a { color:#000; text-decoration:none; }
    a:after { content: " (" attr(href) ")"; font-size:8pt; word-break:break-all; }
    /* Skip showing self-links or same-page anchors */
    a[href^="#"]:after, a[href^="javascript:"]:after { content:''; }
  }
    </style>
  </head>
  <body class="bg-white text-neutral-900">
    <main class="max-w-3xl mx-auto px-4 sm:px-6 py-8">
  <a href="index.html" class="text-sm text-neutral-500 hover:text-[var(--brand)]">&larr; Back to Home</a>

  <header class="mt-2 pb-3 border-b">
        <div id="article-tags" class="flex flex-wrap gap-2"></div>
        <h1 id="article-title" class="font-serif text-3xl md:text-4xl font-extrabold mt-1 leading-tight">Loading...</h1>
        <p id="article-author" class="mt-3 text-[13px] tracking-wide font-medium text-neutral-800 hidden"></p>
        <p id="article-meta" class="text-sm text-neutral-500 mt-1"></p>
        <div class="mt-4 flex flex-wrap items-center gap-4 justify-between" id="article-actions">
          <div class="flex flex-wrap gap-2">
            <button type="button" id="article-share" class="inline-flex items-center justify-center rounded-[3px] border border-[var(--brand)] text-[var(--brand)] px-3 py-1.5 text-xs font-medium hover:bg-[rgba(193,18,31,0.08)] focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:ring-offset-1">Share</button>
            <button type="button" id="article-print" class="inline-flex items-center justify-center rounded-[3px] border border-neutral-300 text-neutral-700 px-3 py-1.5 text-xs font-medium hover:bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:ring-offset-1">Print</button>
          </div>
          <nav id="page-nav-top" class="print-hidden" style="display:none;">
            <div id="compact-pager" class="compact-pager">
              <button type="button" class="nav-edge" id="pager-prev" aria-label="Previous page">←</button>
              <div class="pager-numbers" id="pager-numbers" role="tablist" aria-label="Article pages"></div>
              <button type="button" class="nav-edge" id="pager-next" aria-label="Next page">→</button>
            </div>
            <div id="pager-progress" class="pager-progress-bar print-hidden" role="progressbar" aria-label="Reading progress" aria-valuemin="1" aria-valuemax="1" aria-valuenow="1" aria-valuetext="Page 1 of 1"><div id="pager-progress-fill" class="pager-progress-fill"></div></div>
          </nav>
        </div>
      </header>

      <figure id="article-hero" class="mt-4 hidden">
        <img id="article-hero-img" class="w-full rounded" alt="">
        <figcaption id="article-hero-cap" class="text-xs text-neutral-500 mt-2"></figcaption>
      </figure>
      
      <article id="article-body" class="prose prose-neutral max-w-none mt-6 mb-6"></article>
      
      <nav id="page-nav-bottom" class="print-hidden" style="display: none;">
        <div class="page-indicators" id="page-indicators-bottom"></div>
        <div id="nav-content-bottom" class="text-center mt-4"></div>
      </nav>
    </main>

  <div class="toast-stack" id="toast-stack" aria-live="polite" aria-atomic="false"></div>
  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
      (function(){
        const TZ = 'America/Chicago';
  const qs = new URLSearchParams(location.search);
  const id = qs.get('id');
  const pageParam = parseInt(qs.get('page')||'1',10);

        function fmtDate(iso){
          try {
            return new Date(iso).toLocaleString('en-US', {
              weekday:'long', month:'long', day:'numeric', year:'numeric',
              hour:'numeric', minute:'2-digit', timeZone: TZ
            });
          } catch { return ''; }
        }
        function set(el, v){ if(!el||v==null) return; el.textContent = v; }
        function sanitizeInt(n, min, max){ n = Number.isFinite(n)?n:parseInt(n,10); if(isNaN(n)) return min; return Math.max(min, Math.min(max, n)); }

        if (!id) {
          document.getElementById('article-title').textContent = 'Missing article id';
          return;
        }

    // Cache-buster for fetches to avoid stale JSON during edits
    const ts = Date.now();
    // Fetch catalog metadata, then per-article body from /articles/<id>.json (with graceful fallbacks)
  fetch(`ArticleCatalog.json?ts=${ts}`).then(r=>r.json()).then(catalog => {
          if (!catalog || !Array.isArray(catalog.articles)) throw new Error('Invalid catalog');
          const meta = catalog.articles.find(a => String(a.id) === String(id));
          if (!meta) throw new Error('Article id not found in catalog');
          // Apply metadata early
          set(document.getElementById('article-title'), meta.title || 'Untitled');
          const when = meta.time_posted || meta.date || meta.published_at;
          const who  = meta.author || meta.byline || '';
          const metaBits = [];
          if (when) metaBits.push(fmtDate(when));
          set(document.getElementById('article-meta'), metaBits.join(' • '));
          if (who) {
            const aEl = document.getElementById('article-author');
            aEl.textContent = 'By ' + who;
            aEl.classList.remove('hidden');
          }
          const primary = `articles/${encodeURIComponent(id)}.json`;
          const fallbackRoot = `${encodeURIComponent(id)}.json`; // in case file was saved at project root
          const fallbackNested = `articles/articles/${encodeURIComponent(id)}.json`; // legacy nested path
          function fetchJsonSafe(url){
            return fetch(url + `?ts=${ts}`)
              .then(r => r.ok ? r.json().catch(()=>null) : null)
              .catch(()=>null);
          }
          return fetchJsonSafe(primary).then(body => body ?? fetchJsonSafe(fallbackRoot)).then(body => body ?? fetchJsonSafe(fallbackNested)).then(bodyData => ({ meta, bodyData: bodyData||{} }));
        }).then(({meta, bodyData}) => {
          // Merge shallowly (bodyData can override meta fields like hero, bodyBlocks)
          const article = Object.assign({}, meta, bodyData);
          window.__article = article;

          // If body file carried a more up-to-date title, reflect it now.
          (function(){
            const titleEl = document.getElementById('article-title');
            const newTitle = (article.title || '').trim();
            if (newTitle && titleEl && titleEl.textContent.trim() !== newTitle) {
              titleEl.textContent = newTitle;
            }
          })();

          // If author/byline was missing in catalog but present in body file, render now
          (function(){
            const aEl = document.getElementById('article-author');
            if (aEl) {
              const existingVisible = !aEl.classList.contains('hidden');
              const bodyAuthor = article.author || article.byline;
              if (bodyAuthor) {
                if (!existingVisible || aEl.textContent.trim() === '' || /Loading/i.test(aEl.textContent)) {
                  aEl.textContent = 'By ' + bodyAuthor;
                  aEl.classList.remove('hidden');
                }
              }
            }
          })();

          // Hero image resolution
          const hero = article.hero || {};
          if (!hero.src) {
            const seed = encodeURIComponent(String(article.id||'hero'));
            hero.src = `https://picsum.photos/seed/${seed}/1200/600`;
            hero.alt = hero.alt || 'Placeholder image';
            hero.caption = hero.caption || 'Image placeholder (Lorem Picsum)';
          }
          if (hero.src) {
            const fig = document.getElementById('article-hero');
            const img = document.getElementById('article-hero-img');
            const cap = document.getElementById('article-hero-cap');
            img.src = hero.src; img.alt = hero.alt || ''; if (hero.caption) cap.textContent = hero.caption; fig.classList.remove('hidden');
          }

          // Normalize to pages with Markdown/HTML support
          function blocksToHtml(blocks){
            const html = (blocks||[]).map((block, idx) => {
              if (!block || typeof block !== 'object') return '';
              switch(block.type){
                case 'paragraph': return `<p>${block.text || ''}</p>`;
                case 'list': {
                  const items = Array.isArray(block.items) ? block.items.map(it=>`<li>${it}</li>`).join('') : '';
                  return block.ordered ? `<ol>${items}</ol>` : `<ul>${items}</ul>`;
                }
                case 'image': {
                  if (!block.src) {
                    const seed = encodeURIComponent(String(article.id)+'-'+idx);
                    block.src = `https://picsum.photos/seed/${seed}/900/500`;
                    block.alt = block.alt || 'Placeholder image';
                    block.caption = block.caption || 'Image placeholder (Lorem Picsum)';
                  }
                  const cap = block.caption ? `<figcaption class="text-xs text-neutral-500 mt-2">${block.caption}</figcaption>` : '';
                  return `<figure><img src="${block.src}" alt="${block.alt||''}" class="rounded"/>${cap}</figure>`;
                }
                case 'html': return block.html || '';
                default: return '';
              }
            }).join('\n');
            return html;
          }

          let pages = [];
          if (Array.isArray(article.pages) && article.pages.length){
            pages = article.pages.map((p, i)=>{
              const title = p.title || (article.pageTitles && article.pageTitles[i]) || (i?`Page ${i+1}`:'');
              const html = p.html ? String(p.html) : (p.markdown ? (window.marked ? marked.parse(String(p.markdown)) : `<pre>${String(p.markdown)}</pre>`) : '');
              return { title, html };
            });
          } else if (Array.isArray(article.bodyBlocks)) {
            pages = [{ title:'', html: blocksToHtml(article.bodyBlocks) }];
          } else if (typeof article.markdown === 'string' || typeof article.body === 'string') {
            const md = article.markdown || '';
            const html = window.marked ? marked.parse(md) : `<pre>${md}</pre>`;
            pages = [{ title:'', html }];
          } else if (typeof article.html === 'string') {
            pages = [{ title:'', html: article.html }];
          }

          // --- Reading time calculation (words / 275) ---
          (function(){
            try {
              const combined = pages.map(p=>p.html||'').join(' ');
              // Strip scripts/styles and tags
              const cleaned = combined
                .replace(/<script[\s\S]*?<\/script>/gi,' ')
                .replace(/<style[\s\S]*?<\/style>/gi,' ')
                .replace(/<[^>]+>/g,' ') // remove tags
                .replace(/&[a-zA-Z#0-9]+;?/g,' '); // entities
              const words = cleaned.trim().split(/\s+/).filter(Boolean).length;
              const minutesRaw = words / 275;
              const minutes = Math.max(1, Math.round(minutesRaw));
              const metaEl = document.getElementById('article-meta');
              if(metaEl){
                const existing = metaEl.textContent.trim();
                metaEl.textContent = existing ? `${existing} • ${minutes} min read` : `${minutes} min read`;
              }
              window.__article.readStats = { words, minutes, wpm:275 };
            } catch(e){ console.warn('Read time calc failed', e); }
          })();

          const total = pages.length;
          console.log('Total pages found:', total, pages); // Debug log
          
          const topNav = document.getElementById('page-nav-top');
          const botNav = document.getElementById('page-nav-bottom');
          const bodyEl = document.getElementById('article-body');
          
          if (!total){ 
            bodyEl.innerHTML = '<p class="text-neutral-500">No body content available.</p>'; 
            return; 
          }

          // Show or remove pager based on page count
          if (total > 1) {
            topNav.style.display='block';
          } else if (topNav) {
            // Remove entirely so no layout gap
            topNav.remove();
          }
          function renderPager(current){
            if(total <= 1){ topNav.style.display='none'; return; }
            const numbersEl = document.getElementById('pager-numbers');
            const prevBtn = document.getElementById('pager-prev');
            const nextBtn = document.getElementById('pager-next');
            const progressBar = document.getElementById('pager-progress');
            const progFill = document.getElementById('pager-progress-fill');
            const pct = (current/total)*100; if(progFill) progFill.style.width = pct + '%';
            if(progressBar){
              progressBar.setAttribute('aria-valuemax', String(total));
              progressBar.setAttribute('aria-valuenow', String(current));
              progressBar.setAttribute('aria-valuetext', `Page ${current} of ${total}`);
            }
            // Build condensed list with ellipsis if > 10 pages
            function buildTokens(cur, total){
              const out=[]; const push = v=>out.push(v);
              if(total<=10){ for(let i=1;i<=total;i++) push(i); }
              else {
                const range = (s,e)=>{for(let i=s;i<=e;i++) push(i);};
                push(1);
                if(cur>4) push('…');
                const start = Math.max(2, cur-1);
                const end = Math.min(total-1, cur+1);
                range(start,end);
                if(cur < total-3) push('…');
                push(total);
              }
              return out;
            }
            const tokens = buildTokens(current,total);
            if(numbersEl){
              numbersEl.innerHTML = tokens.map(t => {
                if(t==='…') return '<span class="ellipsis">…</span>';
                const title = pages[t-1]?.title || `Page ${t}`;
                return `<button type="button" class="page-num-btn${t===current?' active':''}" data-page="${t}" aria-label="Go to page ${t}${title?': '+title:''}" ${t===current?'aria-current="page"':''}>${t}</button>`;
              }).join('');
              numbersEl.querySelectorAll('button.page-num-btn').forEach(btn=>{
                btn.addEventListener('click',()=>{ const p=parseInt(btn.getAttribute('data-page'),10); if(!isNaN(p)&&p!==current) setPage(p); });
              });
            }
            if(prevBtn){ prevBtn.disabled = current<=1; prevBtn.onclick = ()=> current>1 && setPage(current-1); }
            if(nextBtn){ nextBtn.disabled = current>=total; nextBtn.textContent = current>=total? '✔' : '→'; nextBtn.onclick = ()=> current<total && setPage(current+1); }
            // Subtle flash highlight on page change
            const pager = document.getElementById('compact-pager');
            if(pager){
              pager.classList.add('ring-change');
              setTimeout(()=>pager.classList.remove('ring-change'), 220);
            }
            console.log('Navigation rendered for page', current, 'of', total);
          }

          function setPage(n){
            const idx = sanitizeInt(n, 1, total) - 1;
            const newPage = idx + 1;
            
            console.log(`Navigating to page ${newPage}`);
            
            // Add transition effect
            bodyEl.classList.add('page-transitioning');
            
            // Scroll to top immediately for better UX
            window.scrollTo({ top: document.querySelector('main').offsetTop, behavior: 'smooth' });
            
            setTimeout(() => {
              bodyEl.innerHTML = pages[idx].html || '';
              bodyEl.classList.remove('page-transitioning');
              renderPager(newPage);
              
              // reflect page in URL without reload
              const url = new URL(location.href);
              if(total>1){ url.searchParams.set('page', String(newPage)); } else { url.searchParams.delete('page'); }
              history.replaceState(null, '', url.toString());
              
              // Update document title with page info
              const baseTitle = document.title.split(' - Page ')[0];
              const currentPageTitle = pages[idx].title;
              if (total > 1 && currentPageTitle) {
                document.title = `${baseTitle} - Page ${newPage}: ${currentPageTitle}`;
              } else if (total > 1) {
                document.title = `${baseTitle} - Page ${newPage} of ${total}`;
              } else {
                document.title = baseTitle;
              }
              
              // Add a subtle success indicator
              const pager = document.getElementById('compact-pager');
              if(pager){
                pager.style.background = '#f0f9ff';
                pager.style.borderRadius = '8px';
                setTimeout(()=>{
                  pager.style.background = '';
                  pager.style.borderRadius = '';
                },200);
              }
              
            }, 150);
          }
          
          // Add debug navigation (temporary)
          function addDebugNav() {
            if (total > 1) {
              const debugNav = document.createElement('div');
              debugNav.className = 'debug-nav';
              debugNav.innerHTML = `
                <strong>DEBUG: Multi-page article detected (${total} pages)</strong><br>
                <button onclick="setPage(1)" style="margin: 5px;">Page 1</button>
                ${total > 1 ? `<button onclick="setPage(2)" style="margin: 5px;">Page 2</button>` : ''}
                ${total > 2 ? `<button onclick="setPage(3)" style="margin: 5px;">Page 3</button>` : ''}
                ${total > 3 ? `<button onclick="setPage(4)" style="margin: 5px;">Page 4</button>` : ''}
                ${total > 4 ? `<button onclick="setPage(5)" style="margin: 5px;">Page 5</button>` : ''}
                ${total > 5 ? `<button onclick="setPage(6)" style="margin: 5px;">Page 6</button>` : ''}
              `;
              
              // Insert after the article header
              const header = document.querySelector('header');
              if (header && header.nextSibling) {
                header.parentNode.insertBefore(debugNav, header.nextSibling);
              }
            }
          }
          
          // Make setPage globally accessible
          window.setPage = setPage;
          
          setPage(isNaN(pageParam)?1:pageParam);
          addDebugNav(); // Add debug navigation
          
          console.log('Article loaded with', total, 'pages. Starting on page', isNaN(pageParam)?1:pageParam); // Debug log

          // Render tags (only on article page). Do not display category here.
          (function(){
            const tagWrap = document.getElementById('article-tags');
            if(!tagWrap) return;
            const tags = Array.isArray(article.tags) ? article.tags : [];
            if(tags.length){
              tagWrap.innerHTML = tags.map(t=>`<span class="tag-pill">${t}</span>`).join(' ');
            } else {
              tagWrap.innerHTML = '';
            }
          })();
        }).catch(err => {
          console.error('[Article] Load failure', err);
          document.getElementById('article-title').textContent = 'Error loading article';
          document.getElementById('article-body').innerHTML = '<p class="text-red-600">Unable to load article metadata or body file.</p>';
        });

        // Share + Print logic
        function pushToast(msg, ttl=3000){
          const stack = document.getElementById('toast-stack');
          if(!stack) return; const el = document.createElement('div');
          el.className='toast'; el.textContent=msg; stack.appendChild(el);
          setTimeout(()=>el.classList.add('fade-out'), ttl-250);
          setTimeout(()=>el.remove(), ttl);
        }
        function shareCurrent(){
          const url = location.href;
            const title = document.getElementById('article-title')?.textContent?.trim() || document.title;
            if(navigator.share){ navigator.share({title, url}).catch(()=>{}); return; }
            try { navigator.clipboard.writeText(url).then(()=>pushToast('Link copied')); }
            catch { pushToast('Copy this link: '+url, 5000); }
        }
        document.getElementById('article-share').addEventListener('click', shareCurrent);
        document.getElementById('article-print').addEventListener('click', ()=>{ window.print(); });
        
        // Keyboard navigation for multi-page articles
        document.addEventListener('keydown', (e) => {
          // Only handle keyboard navigation if we have multiple pages
          if (!window.__article || !Array.isArray(window.__article.pages) || window.__article.pages.length <= 1) return;
          
          const currentUrl = new URL(location.href);
          const currentPage = parseInt(currentUrl.searchParams.get('page') || '1', 10);
          const totalPages = window.__article.pages.length;
          
          // Left arrow or 'p' for previous page
          if ((e.key === 'ArrowLeft' || e.key === 'p') && !e.ctrlKey && !e.metaKey && !e.altKey) {
            const target = e.target;
            // Don't interfere if user is typing in an input field
            if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable) return;
            
            if (currentPage > 1) {
              e.preventDefault();
              setPage(currentPage - 1);
            }
          }
          
          // Right arrow or 'n' for next page  
          if ((e.key === 'ArrowRight' || e.key === 'n') && !e.ctrlKey && !e.metaKey && !e.altKey) {
            const target = e.target;
            // Don't interfere if user is typing in an input field
            if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable) return;
            
            if (currentPage < totalPages) {
              e.preventDefault(); 
              setPage(currentPage + 1);
            }
          }
        });
      })();
    </script>
  </body>
</html>
