<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Leopard Low Down — Article</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { colors: { brand: '#C1121F' } } } };</script>
    <style>
      :root { --brand:#C1121F }
      .smallcaps { font-variant: all-small-caps; letter-spacing:.06em; }
      .font-helvetica { font-family:"Helvetica Neue", Helvetica, Arial, "Liberation Sans", sans-serif; }
  .toast-stack { position: fixed; bottom: 1rem; right: 1rem; display:flex; flex-direction:column; gap:.5rem; z-index:50; }
  .toast { background:#111; color:#fff; padding:.5rem .75rem; font-size:.75rem; border-radius:4px; box-shadow:0 2px 6px rgba(0,0,0,.25); opacity:0; transform:translateY(4px); animation:toast-in .25s forwards; }
  @keyframes toast-in { to { opacity:1; transform:translateY(0);} }
  .toast.fade-out { animation:toast-out .3s forwards; }
  @keyframes toast-out { to { opacity:0; transform:translateY(4px);} }
  .print-hidden { display: none !important; }
  .tag-pill { display:inline-block; border:1px solid var(--brand); color:var(--brand); font-variant:all-small-caps; letter-spacing:.06em; font-size:11px; padding:2px 7px; line-height:1; border-radius:2px; background:rgba(193,18,31,0.06); font-weight:600; }
  /* Increase whitespace between images and following text */
  #article-body.prose img, #article-body.prose figure { margin-bottom: 1.25rem; }
  @media print {
    body { background:#fff !important; color:#000; }
    .toast-stack, #article-actions, a[href="Index.html"], .toast { display:none !important; }
    /* Tags: plain in print */
    #article-tags .tag-pill { border-color:#000; color:#000; background:transparent; }
    #article-title { font-size:28pt !important; line-height:1.15; margin-top:0; }
    #article-author { font-size:11pt !important; }
    #article-meta { font-size:10pt !important; color:#555 !important; }
    #article-hero { page-break-inside: avoid; }
    #article-body { font-size:11pt; line-height:1.4; }
    img { max-width:100%; height:auto; }
    @page { margin: 20mm 16mm 22mm; }
    /* Remove link underlines but append URLs for off-page context */
    a { color:#000; text-decoration:none; }
    a:after { content: " (" attr(href) ")"; font-size:8pt; word-break:break-all; }
    /* Skip showing self-links or same-page anchors */
    a[href^="#"]:after, a[href^="javascript:"]:after { content:''; }
  }
    </style>
  </head>
  <body class="bg-white text-neutral-900">
    <main class="max-w-3xl mx-auto px-4 sm:px-6 py-8">
  <a href="Index.html" class="text-sm text-neutral-500 hover:text-[var(--brand)]">&larr; Back to Home</a>

      <header class="mt-2 pb-4 border-b">
  <div id="article-tags" class="flex flex-wrap gap-2"></div>
        <h1 id="article-title" class="font-serif text-3xl md:text-4xl font-extrabold mt-1 leading-tight">Loading...</h1>
        <p id="article-author" class="mt-3 text-[13px] tracking-wide font-medium text-neutral-800 hidden"></p>
        <p id="article-meta" class="text-sm text-neutral-500 mt-1"></p>
        <div class="mt-4 flex flex-wrap gap-2" id="article-actions">
          <button type="button" id="article-share" class="inline-flex items-center justify-center rounded-[3px] border border-[var(--brand)] text-[var(--brand)] px-3 py-1.5 text-xs font-medium hover:bg-[rgba(193,18,31,0.08)] focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:ring-offset-1">Share</button>
          <button type="button" id="article-print" class="inline-flex items-center justify-center rounded-[3px] border border-neutral-300 text-neutral-700 px-3 py-1.5 text-xs font-medium hover:bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:ring-offset-1">Print</button>
        </div>
      </header>

      <figure id="article-hero" class="mt-6 hidden">
        <img id="article-hero-img" class="w-full rounded" alt="">
        <figcaption id="article-hero-cap" class="text-xs text-neutral-500 mt-2"></figcaption>
      </figure>

      <nav id="page-nav-top" class="mt-6 hidden print-hidden"></nav>
      <article id="article-body" class="prose prose-neutral max-w-none mt-6"></article>
      <nav id="page-nav-bottom" class="mt-6 hidden print-hidden"></nav>
    </main>

  <div class="toast-stack" id="toast-stack" aria-live="polite" aria-atomic="false"></div>
  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
      (function(){
        const TZ = 'America/Chicago';
  const qs = new URLSearchParams(location.search);
  const id = qs.get('id');
  const pageParam = parseInt(qs.get('page')||'1',10);

        function fmtDate(iso){
          try {
            return new Date(iso).toLocaleString('en-US', {
              weekday:'long', month:'long', day:'numeric', year:'numeric',
              hour:'numeric', minute:'2-digit', timeZone: TZ
            });
          } catch { return ''; }
        }
        function set(el, v){ if(!el||v==null) return; el.textContent = v; }
        function sanitizeInt(n, min, max){ n = Number.isFinite(n)?n:parseInt(n,10); if(isNaN(n)) return min; return Math.max(min, Math.min(max, n)); }

        if (!id) {
          document.getElementById('article-title').textContent = 'Missing article id';
          return;
        }

    // Cache-buster for fetches to avoid stale JSON during edits
    const ts = Date.now();
    // Fetch catalog metadata, then per-article body from /articles/<id>.json (with graceful fallbacks)
  fetch(`ArticleCatalog.json?ts=${ts}`).then(r=>r.json()).then(catalog => {
          if (!catalog || !Array.isArray(catalog.articles)) throw new Error('Invalid catalog');
          const meta = catalog.articles.find(a => String(a.id) === String(id));
          if (!meta) throw new Error('Article id not found in catalog');
          // Apply metadata early
          set(document.getElementById('article-title'), meta.title || 'Untitled');
          const when = meta.time_posted || meta.date || meta.published_at;
          const who  = meta.author || meta.byline || '';
          const metaBits = [];
          if (when) metaBits.push(fmtDate(when));
          set(document.getElementById('article-meta'), metaBits.join(' • '));
          if (who) {
            const aEl = document.getElementById('article-author');
            aEl.textContent = 'By ' + who;
            aEl.classList.remove('hidden');
          }
          const primary = `articles/${encodeURIComponent(id)}.json`;
          const fallbackRoot = `${encodeURIComponent(id)}.json`; // in case file was saved at project root
          const fallbackNested = `articles/articles/${encodeURIComponent(id)}.json`; // legacy nested path
          function fetchJsonSafe(url){
            return fetch(url + `?ts=${ts}`)
              .then(r => r.ok ? r.json().catch(()=>null) : null)
              .catch(()=>null);
          }
          return fetchJsonSafe(primary).then(body => body ?? fetchJsonSafe(fallbackRoot)).then(body => body ?? fetchJsonSafe(fallbackNested)).then(bodyData => ({ meta, bodyData: bodyData||{} }));
        }).then(({meta, bodyData}) => {
          // Merge shallowly (bodyData can override meta fields like hero, bodyBlocks)
          const article = Object.assign({}, meta, bodyData);
          window.__article = article;

          // If body file carried a more up-to-date title, reflect it now.
          (function(){
            const titleEl = document.getElementById('article-title');
            const newTitle = (article.title || '').trim();
            if (newTitle && titleEl && titleEl.textContent.trim() !== newTitle) {
              titleEl.textContent = newTitle;
            }
          })();

          // If author/byline was missing in catalog but present in body file, render now
          (function(){
            const aEl = document.getElementById('article-author');
            if (aEl) {
              const existingVisible = !aEl.classList.contains('hidden');
              const bodyAuthor = article.author || article.byline;
              if (bodyAuthor) {
                if (!existingVisible || aEl.textContent.trim() === '' || /Loading/i.test(aEl.textContent)) {
                  aEl.textContent = 'By ' + bodyAuthor;
                  aEl.classList.remove('hidden');
                }
              }
            }
          })();

          // Hero image resolution
          const hero = article.hero || {};
          if (!hero.src) {
            const seed = encodeURIComponent(String(article.id||'hero'));
            hero.src = `https://picsum.photos/seed/${seed}/1200/600`;
            hero.alt = hero.alt || 'Placeholder image';
            hero.caption = hero.caption || 'Image placeholder (Lorem Picsum)';
          }
          if (hero.src) {
            const fig = document.getElementById('article-hero');
            const img = document.getElementById('article-hero-img');
            const cap = document.getElementById('article-hero-cap');
            img.src = hero.src; img.alt = hero.alt || ''; if (hero.caption) cap.textContent = hero.caption; fig.classList.remove('hidden');
          }

          // Normalize to pages with Markdown/HTML support
          function blocksToHtml(blocks){
            const html = (blocks||[]).map((block, idx) => {
              if (!block || typeof block !== 'object') return '';
              switch(block.type){
                case 'paragraph': return `<p>${block.text || ''}</p>`;
                case 'list': {
                  const items = Array.isArray(block.items) ? block.items.map(it=>`<li>${it}</li>`).join('') : '';
                  return block.ordered ? `<ol>${items}</ol>` : `<ul>${items}</ul>`;
                }
                case 'image': {
                  if (!block.src) {
                    const seed = encodeURIComponent(String(article.id)+'-'+idx);
                    block.src = `https://picsum.photos/seed/${seed}/900/500`;
                    block.alt = block.alt || 'Placeholder image';
                    block.caption = block.caption || 'Image placeholder (Lorem Picsum)';
                  }
                  const cap = block.caption ? `<figcaption class="text-xs text-neutral-500 mt-2">${block.caption}</figcaption>` : '';
                  return `<figure><img src="${block.src}" alt="${block.alt||''}" class="rounded"/>${cap}</figure>`;
                }
                case 'html': return block.html || '';
                default: return '';
              }
            }).join('\n');
            return html;
          }

          let pages = [];
          if (Array.isArray(article.pages) && article.pages.length){
            pages = article.pages.map((p, i)=>{
              const title = p.title || (article.pageTitles && article.pageTitles[i]) || (i?`Page ${i+1}`:'');
              const html = p.html ? String(p.html) : (p.markdown ? (window.marked ? marked.parse(String(p.markdown)) : `<pre>${String(p.markdown)}</pre>`) : '');
              return { title, html };
            });
          } else if (Array.isArray(article.bodyBlocks)) {
            pages = [{ title:'', html: blocksToHtml(article.bodyBlocks) }];
          } else if (typeof article.markdown === 'string' || typeof article.body === 'string') {
            const md = article.markdown || '';
            const html = window.marked ? marked.parse(md) : `<pre>${md}</pre>`;
            pages = [{ title:'', html }];
          } else if (typeof article.html === 'string') {
            pages = [{ title:'', html: article.html }];
          }

          const total = pages.length;
          const topNav = document.getElementById('page-nav-top');
          const botNav = document.getElementById('page-nav-bottom');
          const bodyEl = document.getElementById('article-body');
          if (!total){ bodyEl.innerHTML = '<p class="text-neutral-500">No body content available.</p>'; return; }

          function renderPager(current){
            if(total<=1){ topNav.classList.add('hidden'); botNav.classList.add('hidden'); return; }
            const makeBtn = (label, target, disabled=false)=>`<button type="button" data-page="${target}" ${disabled?'disabled':''} class="px-3 py-1.5 text-xs border rounded-[3px] ${disabled?'text-neutral-400 border-neutral-200':'border-neutral-300 hover:bg-neutral-100'}">${label}</button>`;
            const status = `<span class="text-xs text-neutral-600">Page ${current} of ${total}</span>`;
            const prev = makeBtn('Prev', current-1, current<=1);
            const next = makeBtn('Next', current+1, current>=total);
            const html = `<div class="flex items-center justify-between">${prev}${status}${next}</div>`;
            [topNav, botNav].forEach(nav=>{ nav.innerHTML = html; nav.classList.remove('hidden'); });
            [topNav, botNav].forEach(nav=>{
              nav.querySelectorAll('button[data-page]').forEach(btn=>{
                btn.addEventListener('click', (e)=>{
                  const target = parseInt(e.currentTarget.getAttribute('data-page'),10);
                  setPage(target);
                });
              });
            });
          }

          function setPage(n){
            const idx = sanitizeInt(n, 1, total) - 1;
            bodyEl.innerHTML = pages[idx].html || '';
            renderPager(idx+1);
            // reflect page in URL without reload
            const url = new URL(location.href);
            if(total>1){ url.searchParams.set('page', String(idx+1)); } else { url.searchParams.delete('page'); }
            history.replaceState(null, '', url.toString());
            // Ensure top of article visible on navigation
            window.scrollTo({ top: document.querySelector('main').offsetTop, behavior: 'smooth' });
          }

          setPage(isNaN(pageParam)?1:pageParam);

          // Render tags (only on article page). Do not display category here.
          (function(){
            const tagWrap = document.getElementById('article-tags');
            if(!tagWrap) return;
            const tags = Array.isArray(article.tags) ? article.tags : [];
            if(tags.length){
              tagWrap.innerHTML = tags.map(t=>`<span class="tag-pill">${t}</span>`).join(' ');
            } else {
              tagWrap.innerHTML = '';
            }
          })();
        }).catch(err => {
          console.error('[Article] Load failure', err);
          document.getElementById('article-title').textContent = 'Error loading article';
          document.getElementById('article-body').innerHTML = '<p class="text-red-600">Unable to load article metadata or body file.</p>';
        });

        // Share + Print logic
        function pushToast(msg, ttl=3000){
          const stack = document.getElementById('toast-stack');
          if(!stack) return; const el = document.createElement('div');
          el.className='toast'; el.textContent=msg; stack.appendChild(el);
          setTimeout(()=>el.classList.add('fade-out'), ttl-250);
          setTimeout(()=>el.remove(), ttl);
        }
        function shareCurrent(){
          const url = location.href;
            const title = document.getElementById('article-title')?.textContent?.trim() || document.title;
            if(navigator.share){ navigator.share({title, url}).catch(()=>{}); return; }
            try { navigator.clipboard.writeText(url).then(()=>pushToast('Link copied')); }
            catch { pushToast('Copy this link: '+url, 5000); }
        }
        document.getElementById('article-share').addEventListener('click', shareCurrent);
        document.getElementById('article-print').addEventListener('click', ()=>{ window.print(); });
      })();
    </script>
  </body>
</html>
